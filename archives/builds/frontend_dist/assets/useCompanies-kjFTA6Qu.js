import{r as p,g as D,u as q,W as g,as as G,E as b,a2 as C}from"./index-D951x4H-.js";function z(){const[E,l]=p.useState([]),[I,x]=p.useState(!1),w=p.useRef(!1),{toast:f}=D(),{profile:t}=q(),_=t==null?void 0:t.id,v=t==null?void 0:t.role,h=t==null?void 0:t.companyId,y=p.useCallback(async(s=!1)=>{if(!(I&&!s)&&!(w.current&&!s)){x(!0),w.current=!0;try{if(navigator.onLine){let e=g.from("companies").select("*").order("name");!(G(t)||b(v))&&h&&(e=e.eq("id",h));const{data:i,error:c}=await e;if(c)throw c;const d=(i||[]).map(r=>({id:r.id,name:r.name,taxId:r.taxId||r.tax_id,address:r.address,phone:r.phone,logoUrl:r.logoUrl||r.logo_url,createdAt:new Date(r.createdAt||r.created_at||Date.now())}));l(d),C.setItem("companies",d)}else{const e=await C.getItem("companies")||[];l(e)}}catch(e){console.error("Error loading companies:",e);const n=await C.getItem("companies")||[];l(n)}finally{x(!1)}}},[_,v,h]);return p.useEffect(()=>{y()},[y]),{companies:E,isLoading:I,createCompany:async s=>{var e,n,i,c,d;console.log("[useCompanies] Criando empresa com dados:",s);try{const r={name:(e=s.name)==null?void 0:e.trim()};(n=s.taxId)!=null&&n.trim()&&(r.taxId=s.taxId.trim()),(i=s.address)!=null&&i.trim()&&(r.address=s.address.trim()),(c=s.phone)!=null&&c.trim()&&(r.phone=s.phone.trim()),(d=s.logoUrl)!=null&&d.trim()&&(r.logoUrl=s.logoUrl.trim()),console.log("[useCompanies] Payload final:",r);const{data:o,error:a}=await g.from("companies").insert(r).select().single();if(a)throw console.error("[useCompanies] Erro na inserção:",a),a;console.log("[useCompanies] Empresa criada com sucesso:",o);const m={id:o.id,name:o.name,taxId:o.taxId||o.tax_id,address:o.address,phone:o.phone,logoUrl:o.logoUrl||o.logo_url,createdAt:new Date(o.createdAt||o.created_at||Date.now())};return l(u=>[...u,m]),{success:!0,data:m}}catch(r){return console.error("[useCompanies] Exception in createCompany:",r),f({title:"Erro ao criar empresa",description:r.message,variant:"destructive"}),{success:!1,error:r.message}}},updateCompany:async(s,e)=>{var n,i,c,d,r;try{const o={name:(n=e.name)==null?void 0:n.trim()};e.taxId!==void 0&&(o.taxId=((i=e.taxId)==null?void 0:i.trim())||null),e.address!==void 0&&(o.address=((c=e.address)==null?void 0:c.trim())||null),e.phone!==void 0&&(o.phone=((d=e.phone)==null?void 0:d.trim())||null),e.logoUrl!==void 0&&(o.logoUrl=((r=e.logoUrl)==null?void 0:r.trim())||null);const{data:a,error:m}=await g.from("companies").update(o).eq("id",s).select().single();if(m)throw m;const u={id:a.id,name:a.name,taxId:a.taxId||a.tax_id,address:a.address,phone:a.phone,logoUrl:a.logoUrl||a.logo_url,createdAt:new Date(a.createdAt||a.created_at||Date.now())};return l(A=>A.map(U=>U.id===s?u:U)),{success:!0,data:u}}catch(o){return f({title:"Erro ao atualizar empresa",description:o.message,variant:"destructive"}),{success:!1,error:o.message}}},deleteCompany:async s=>{try{const{error:e}=await g.from("companies").delete().eq("id",s);if(e)throw e;return l(n=>n.filter(i=>i.id!==s)),{success:!0}}catch(e){return f({title:"Erro ao excluir empresa",description:e.message,variant:"destructive"}),{success:!1,error:e.message}}},refresh:y}}export{z as u};
