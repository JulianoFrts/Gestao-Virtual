import{r as l,g as I,W as d,a2 as a,aT as h,aM as g}from"./index-D951x4H-.js";function _(){const[s,o]=l.useState([]),[m,y]=l.useState(!1),{toast:f}=I(),v=l.useRef(!1),p=l.useCallback(async(n=!1)=>{if(!((m||v.current)&&!n)){y(!0),v.current=!0;try{if(navigator.onLine){const{data:t,error:c}=await d.from("job_functions").select("*").order("level",{ascending:!1}).order("name");if(c)throw c;const r=(t||[]).map(e=>({id:e.id,companyId:e.companyId||e.company_id,name:e.name,description:e.description,canLeadTeam:e.canLeadTeam||e.can_lead_team||!1,hierarchyLevel:e.hierarchyLevel||e.level||e.hierarchy_level||0,createdAt:new Date(e.created_at||e.createdAt||Date.now()),company:e.company}));o(r),a.setItem("functions",r)}else{const t=await a.getItem("functions")||[];o(t)}}catch(t){console.error("Error loading functions:",t);const c=await a.getItem("functions")||[];o(c)}finally{y(!1)}}},[m]);return l.useEffect(()=>{p()},[p]),{functions:s,isLoading:m,createFunction:async n=>{const t=g(),c={id:t,companyId:n.companyId||null,name:n.name,description:n.description||null,canLeadTeam:n.canLeadTeam,hierarchyLevel:n.hierarchyLevel||0,createdAt:new Date};if(o(r=>[...r,c]),a.setItem("functions",[...s,c]),navigator.onLine)try{const{data:r,error:e}=await d.from("job_functions").insert({name:n.name,description:n.description||null,canLeadTeam:n.canLeadTeam,hierarchyLevel:n.hierarchyLevel||0,companyId:n.companyId||null}).select().single();if(e)throw e;const u={...c,id:r.id};return o(i=>i.map(L=>L.id===t?u:L)),a.setItem("functions",s.map(i=>i.id===t?u:i)),{success:!0,data:u}}catch(r){const e=h(r);return f({title:"Erro ao criar função",description:e,variant:"destructive"}),o(u=>u.filter(i=>i.id!==t)),{success:!1,error:e}}else return a.addToSyncQueue({operation:"insert",table:"job_functions",data:{...n,localId:t}}),{success:!0,data:c,offline:!0}},updateFunction:async(n,t)=>{const c=[...s];if(o(r=>r.map(e=>e.id===n?{...e,name:t.name,description:t.description,canLeadTeam:t.canLeadTeam,hierarchyLevel:t.hierarchyLevel??e.hierarchyLevel}:e)),navigator.onLine)try{const{error:r}=await d.from("job_functions").update({name:t.name,description:t.description||null,can_lead_team:t.canLeadTeam,hierarchyLevel:t.hierarchyLevel??0}).eq("id",n);if(r)throw r;return a.setItem("functions",s.map(e=>e.id===n?{...e,...t}:e)),{success:!0}}catch(r){o(c);const e=h(r);return f({title:"Erro ao atualizar função",description:e,variant:"destructive"}),{success:!1,error:e}}else return a.addToSyncQueue({operation:"update",table:"job_functions",id:n,data:t}),a.setItem("functions",s),{success:!0,offline:!0}},deleteFunction:async n=>{const t=[...s];if(o(c=>c.filter(r=>r.id!==n)),navigator.onLine)try{const{error:c}=await d.from("job_functions").delete().eq("id",n);if(c)throw c;return a.setItem("functions",s.filter(r=>r.id!==n)),{success:!0}}catch(c){o(t);const r=h(c);return f({title:"Erro ao remover função",description:r,variant:"destructive"}),{success:!1,error:r}}else return a.addToSyncQueue({operation:"delete",table:"job_functions",id:n}),a.setItem("functions",s.filter(c=>c.id!==n)),{success:!0,offline:!0}},refresh:p}}export{_ as u};
