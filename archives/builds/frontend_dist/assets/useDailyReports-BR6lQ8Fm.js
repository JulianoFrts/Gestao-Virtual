import{r as f,g as B,a2 as r,W as v,aL as I,aM as N}from"./index-D951x4H-.js";function x(){const[h,d]=f.useState([]),[A,R]=f.useState(!0),{toast:D}=B(),_=async e=>{await r.setItem("dailyReports",e)},g=f.useCallback(async()=>{R(!0);try{const e=await r.getItem("dailyReports")||[],a=e.filter(o=>!o.syncedAt);if(navigator.onLine){const{data:o,error:S}=await v.from("daily_reports").select(`
            *,
            user:users!daily_reports_user_id_fkey(name)
          `).order("report_date",{ascending:!1}).limit(100);if(S)throw S;const w=(o||[]).map(t=>{var m,u;return{id:t.id,teamId:t.team_id,teamName:(m=t.teams)==null?void 0:m.name,userId:t.user_id,userName:((u=t.user)==null?void 0:u.name)||"Sistema",reportDate:I(t.report_date)||new Date,activities:t.activities,observations:t.observations,subPoint:t.sub_point,subPointType:t.sub_point_type,metadata:t.metadata,employeeId:t.user_id,companyId:t.company_id,createdBy:t.created_by,syncedAt:I(t.synced_at),localId:t.local_id,createdAt:I(t.created_at)||new Date}}),p=new Set(w.map(t=>t.localId).filter(Boolean)),n=[...a.filter(t=>!t.localId||!p.has(t.localId)),...w];d(n),await _(n)}else d(e)}catch(e){console.error("Error loading daily reports:",e);const a=await r.getItem("dailyReports")||[];d(a)}finally{R(!1)}},[]);return f.useEffect(()=>{g()},[g]),{reports:h,isLoading:A,createReport:async e=>{var u,k,T,O;const a=N();let o=null;try{o=((k=(u=(await v.auth.getSession()).data.session)==null?void 0:u.user)==null?void 0:k.id)||null}catch{console.warn("Network auth check failed, using local fallback")}if(!o)for(let s=0;s<localStorage.length;s++){const i=localStorage.key(s);if(i&&i.startsWith("sb-")&&i.endsWith("-auth-token"))try{const l=localStorage.getItem(i);if(l){const b=JSON.parse(l);if((T=b.user)!=null&&T.id){o=b.user.id;break}}}catch{}}const p=!!await r.getItem("manual_worker_session")?null:o,c=new Date,n={id:a,teamId:e.teamId||null,reportDate:c,activities:e.activities,observations:e.observations||null,employeeId:e.employeeId,companyId:e.companyId||null,createdBy:p,subPoint:e.subPoint||null,subPointType:e.subPointType||null,metadata:{...e.metadata||{},teamIds:e.teamIds||[]},syncedAt:null,localId:a,createdAt:c},t=navigator.onLine;d(s=>[n,...s]);const m=await r.getItem("dailyReports")||[];if(await _([n,...m]),t)try{const{data:s,error:i}=await v.from("daily_reports").insert({team_id:e.teamId||null,report_date:c.toISOString().split("T")[0],activities:e.activities,observations:e.observations||null,user_id:e.employeeId,company_id:e.companyId||null,created_by:p,sub_point:e.subPoint||null,sub_point_type:e.subPointType||null,metadata:{...e.metadata||{},teamIds:e.teamIds||[]},synced_at:new Date().toISOString(),local_id:a}).select("*, teams(name), user:users!daily_reports_user_id_fkey(name)").single();if(i)throw i;const l={...n,id:s.id,teamName:(O=s.teams)==null?void 0:O.name,syncedAt:new Date(s.synced_at||new Date)};d(y=>y.map(P=>P.localId===a?l:P));const L=(await r.getItem("dailyReports")||[]).map(y=>y.localId===a?l:y);return await _(L),{success:!0,data:l}}catch(s){return console.warn("Online sync failed, falling back to offline mode:",s),await r.addToSyncQueue({operation:"insert",table:"daily_reports",data:{...e,localId:a,reportDate:c.toISOString(),createdBy:o}}),D({title:"Salvo offline",description:"Relatório salvo localmente. Será sincronizado quando houver conexão.",duration:3e3}),{success:!0,data:n,offline:!0}}else return await r.addToSyncQueue({operation:"insert",table:"daily_reports",data:{...e,localId:a,reportDate:c.toISOString(),createdBy:o}}),D({title:"Modo Offline",description:"Relatório salvo localmente.",duration:3e3}),{success:!0,data:n,offline:!0}},getTodayReports:()=>{const e=new Date().toDateString();return h.filter(a=>{var o;return((o=I(a.reportDate))==null?void 0:o.toDateString())===e})},refresh:g}}export{x as u};
