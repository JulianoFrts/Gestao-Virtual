import{N as pe,u as xe,a as he,c as fe,b as je,w as ve,r as l,g as be,j as e,D as ge,i as g,d as h,h as Ne,B as f,k as Ie,l as ye,m as Ce,o as Se,p as d,S as N,G as I,H as y,I as C,J as j,Y as we,Z as Ee,_ as Te,$ as qe,s as Oe,L as De,a0 as Le,U as Pe}from"./index-D951x4H-.js";import{L as ke}from"./LoadingScreen-SEZW07K4.js";import{u as Ae}from"./useSites-Dum3dnEP.js";import{u as Ue}from"./useCompanies-kjFTA6Qu.js";import{u as Fe}from"./useJobFunctions-BUngp12J.js";import{I as F}from"./input-dNnkIPn6.js";import{C as Me,b as Ve,c as ze,d as $e,a as Be}from"./card-BTHGlYFz.js";import{C as Re}from"./checkbox-B9hZgst_.js";import{S as Ge}from"./scroll-area-C9sC2RNd.js";import{C as He,a as _e,b as Je,c as Ze,d as Qe,e as Ye}from"./command-DzEVDCzR.js";import{C as Ke}from"./ConfirmationDialog-96fSVVNc.js";import{P as We}from"./ProjectEmptyState-CRpC4Dgy.js";import{P as Xe}from"./plus-DmkF01H_.js";import{C as E}from"./circle-alert-BlgUQYiE.js";import{C as M}from"./crown-CP1ihsrK.js";import{C as es}from"./chevrons-up-down-BNQt7ayD.js";import{S as se}from"./search-BoEw84GM.js";import{L as ae}from"./lock-BtTOdZOV.js";import{P as ss}from"./pencil-DX9IZKx2.js";import{T as as}from"./trash-2-DD2QlM38.js";import"./alert-dialog-qR-bbYaw.js";import"./triangle-alert-BPKdZxxI.js";import"./upload-D2Q7C-3S.js";function Es(){pe();const{profile:rs}=xe();he();const{teams:T,isLoading:V,createTeam:re,updateTeam:ie,deleteTeam:te}=fe(),{employees:z}=je(),{sites:c}=Ae(),{projects:q}=ve(),{companies:O}=Ue(),{functions:$}=Fe(),[B,ne]=l.useState(""),[v,D]=l.useState("all"),[u,L]=l.useState("all"),[P,k]=l.useState("all"),[le,S]=l.useState(!1),[o,R]=l.useState(null),[G,H]=l.useState(!1),[r,m]=l.useState({name:"",supervisorId:"",members:[],siteId:"",companyId:"",projectId:""}),[_,J]=l.useState(""),[Z,Q]=l.useState(!1),[b,Y]=l.useState({open:!1,title:"",description:"",onConfirm:()=>{},variant:"default"}),{toast:p}=be(),w=z.filter(s=>s.isActive),K=()=>{const s=new Set;return T.forEach(a=>{var i;a.id!==(o==null?void 0:o.id)&&((i=a.members)==null||i.forEach(t=>s.add(t)))}),s},W=()=>{const s=new Set;return T.forEach(a=>{a.id!==(o==null?void 0:o.id)&&a.supervisorId&&s.add(a.supervisorId)}),s},A=l.useMemo(()=>{if(!r.siteId)return[];const s=c.find(a=>a.id===r.siteId);return s?w.filter(a=>a.siteId===r.siteId||a.companyId===s.companyId):w},[w,r.siteId,c]),X=l.useMemo(()=>A.filter(s=>{if(!s.functionId)return!1;const a=$.find(i=>i.id===s.functionId);return(a==null?void 0:a.canLeadTeam)===!0}),[A,$]),oe=s=>{var a;return((a=z.find(i=>i.id===s))==null?void 0:a.fullName)||"Desconhecido"},de=async s=>{var a;if(s.preventDefault(),!r.name.trim()){p({title:"Erro",description:"O nome da equipe é obrigatório",variant:"destructive"});return}H(!0);try{const i=c.find(n=>n.id===r.siteId),t=r.companyId||(i==null?void 0:i.companyId)||((a=O[0])==null?void 0:a.id);o?(await ie(o.id,{name:r.name,supervisorId:r.supervisorId||void 0,members:r.members,siteId:r.siteId||void 0,companyId:t})).success&&p({title:"Equipe atualizada!"}):(await re({name:r.name,supervisorId:r.supervisorId||void 0,members:r.members,siteId:r.siteId||void 0,companyId:t})).success&&p({title:"Equipe criada!"}),U()}finally{H(!1)}},U=()=>{m({name:"",supervisorId:"",members:[],siteId:"",companyId:"",projectId:""}),R(null),J(""),S(!1)},ce=async s=>{Y({open:!0,title:"Excluir Equipe",description:`Deseja realmente excluir a equipe "${s.name}"? Esta ação removerá a organização da equipe mas não excluirá os funcionários.`,variant:"destructive",onConfirm:async()=>{(await te(s.id)).success&&p({title:"Equipe excluída"})}})},me=s=>{const a=K();if(!r.members.includes(s)&&a.has(s)){p({title:"Funcionário já está em outra equipe",description:"Um funcionário não pode estar em múltiplas equipes simultaneamente.",variant:"destructive"});return}if(s===r.supervisorId&&r.members.includes(s)){p({title:"O líder deve ser membro da equipe",description:"Para remover este funcionário dos membros, você deve primeiro alterar o supervisor da equipe.",variant:"destructive"});return}m(i=>({...i,members:i.members.includes(s)?i.members.filter(t=>t!==s):[...i.members,s]}))},ee=T.filter(s=>{const a=s.name.toLowerCase().includes(B.toLowerCase()),i=v==="all"||s.companyId===v,t=c.find(ue=>ue.id===s.siteId),n=u==="all"||(t==null?void 0:t.projectId)===u,x=P==="all"||s.siteId===P;return a&&i&&n&&x});return V?e.jsx(ke,{isLoading:!0,title:"GESTÃO DE EQUIPES",message:"SINCRONIZANDO ESTRUTURAS",details:[{label:"Equipes",isLoading:V},{label:"Funcionários",isLoading:!1}]}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:e.jsxs(ge,{open:le,onOpenChange:s=>{s||U(),S(s)},children:[(g.value||h("teams.create"))&&e.jsx(Ne,{asChild:!0,children:e.jsxs(f,{className:"gradient-primary text-white shadow-glow",children:[e.jsx(Xe,{className:"w-4 h-4 mr-2"}),"Nova Equipe"]})}),e.jsxs(Ie,{className:"max-w-md",children:[e.jsxs(ye,{children:[e.jsxs(Ce,{children:[o?"Editar":"Nova"," Equipe"]}),e.jsx(Se,{children:"Preencha os dados da equipe de trabalho"})]}),w.length===0?e.jsxs("div",{className:"p-6 text-center space-y-3 bg-muted/20 rounded-lg",children:[e.jsx(E,{className:"w-10 h-10 text-warning mx-auto"}),e.jsx("p",{className:"text-sm font-medium",children:"Nenhum funcionário ativo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cadastre e ative funcionários antes de montar uma equipe."}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>window.location.href="/employees",children:"Ir para Funcionários"})]}):e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Nome da Equipe *"}),e.jsx(F,{placeholder:"Ex: Equipe de Alvenaria",value:r.name,onChange:s=>m(a=>({...a,name:s.target.value})),className:"industrial-input"})]}),h("system.is_corporate")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Empresa Afiliada *"}),e.jsxs(N,{value:r.companyId,onValueChange:s=>m(a=>({...a,companyId:s,projectId:"",siteId:"",supervisorId:"",members:[]})),children:[e.jsx(I,{className:"industrial-input",children:e.jsx(y,{placeholder:"Selecione a empresa"})}),e.jsx(C,{children:O.map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Obra Vinculada *"}),e.jsxs(N,{value:r.projectId,onValueChange:s=>m(a=>({...a,projectId:s,siteId:"",supervisorId:"",members:[]})),disabled:!r.companyId&&h("system.is_corporate"),children:[e.jsx(I,{className:"industrial-input",children:e.jsx(y,{placeholder:"Selecione a obra"})}),e.jsx(C,{children:q.filter(s=>!r.companyId||s.companyId===r.companyId).map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Canteiro / Unidade *"}),e.jsxs(N,{value:r.siteId,onValueChange:s=>m(a=>({...a,siteId:s,supervisorId:"",members:[]})),disabled:!r.projectId,children:[e.jsx(I,{className:"industrial-input",children:e.jsx(y,{placeholder:"Selecione o local"})}),e.jsx(C,{children:c.filter(s=>s.projectId===r.projectId).map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Supervisor (Líder)"}),!r.siteId&&e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-amber-500/10 border border-amber-500/20 rounded-md text-xs text-amber-600",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{children:"Selecione um canteiro primeiro"})]}),r.siteId&&X.length===0&&e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-red-500/10 border border-red-500/20 rounded-md text-xs text-red-600",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{children:"Nenhum funcionário com função de liderança disponível neste canteiro"})]}),e.jsxs(we,{open:Z,onOpenChange:Q,children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(f,{variant:"outline",role:"combobox","aria-expanded":Z,className:"w-full justify-between industrial-input h-10 font-normal",disabled:!r.siteId,children:[r.supervisorId?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-3.5 h-3.5 text-yellow-500"}),e.jsx("span",{children:oe(r.supervisorId)})]}):e.jsx("span",{className:"text-muted-foreground",children:"Selecione um líder..."}),e.jsx(es,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Te,{className:"w-[400px] p-0 border-slate-800",align:"start",children:e.jsxs(He,{className:"bg-slate-900 text-slate-200",children:[e.jsx(_e,{placeholder:"Procurar líder...",className:"h-9"}),e.jsxs(Je,{children:[e.jsx(Ze,{children:"Nenhum líder encontrado."}),e.jsx(Qe,{heading:"Lideranças Disponíveis",children:X.map(s=>{const i=W().has(s.id);return e.jsxs(Ye,{value:s.fullName,onSelect:()=>{if(W().has(s.id)){p({title:"Líder já está em outra equipe",description:"Este funcionário já é líder de outra equipe.",variant:"destructive"});return}m(n=>{const x=[...n.members];return x.includes(s.id)||x.push(s.id),{...n,supervisorId:s.id,members:x}}),Q(!1)},className:"flex items-center justify-between p-2 cursor-pointer hover:bg-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-3.5 h-3.5 text-yellow-500"}),e.jsx("span",{children:s.fullName}),e.jsx("span",{className:"text-[10px] text-muted-foreground uppercase",children:s.functionName})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[i&&e.jsx("span",{className:"text-[9px] bg-amber-500/10 text-amber-500 px-2 py-0.5 rounded-full border border-amber-500/20",children:"Líder de outra equipe"}),e.jsx(qe,{className:Oe("h-4 w-4 text-primary",r.supervisorId===s.id?"opacity-100":"opacity-0")})]})]},s.id)})})]})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{children:["Membros da Equipe (",r.members.length,")"]}),!r.siteId&&e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-amber-500/10 border border-amber-500/20 rounded-md text-xs text-amber-600",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{children:"Selecione um canteiro primeiro para ver os funcionários disponíveis"})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx(se,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3 w-3 text-muted-foreground"}),e.jsx(F,{placeholder:"Procurar membro...",value:_,onChange:s=>J(s.target.value),className:"pl-7 h-8 text-[11px] industrial-input"})]}),e.jsx(Ge,{className:"h-48 border rounded-lg p-3 bg-muted/10",children:e.jsx("div",{className:"space-y-1",children:A.filter(s=>s.fullName.toLowerCase().includes(_.toLowerCase())).map(s=>{const i=K().has(s.id),t=i&&!r.members.includes(s.id);return e.jsxs("div",{className:`flex items-center gap-3 p-2 rounded-md transition-colors ${t?"opacity-50 cursor-not-allowed bg-muted/20":"hover:bg-muted/50"}`,children:[e.jsx(Re,{id:`emp-check-${s.id}`,checked:r.members.includes(s.id),onCheckedChange:()=>me(s.id),disabled:t}),e.jsxs("label",{htmlFor:`emp-check-${s.id}`,className:"text-sm flex-1 cursor-pointer select-none py-1 flex items-center justify-between",children:[e.jsx("span",{children:s.fullName}),i&&!r.members.includes(s.id)&&e.jsx("span",{className:"text-[10px] bg-amber-500/20 text-amber-600 px-2 py-0.5 rounded-full font-medium",children:"Em outra equipe"})]})]},s.id)})})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(f,{type:"button",variant:"outline",onClick:U,className:"flex-1",children:"Cancelar"}),e.jsxs(f,{type:"submit",className:"flex-1 gradient-primary text-white",disabled:G,children:[G&&e.jsx(De,{className:"w-4 h-4 mr-2 animate-spin"}),o?"Salvar Alterações":"Criar Equipe"]})]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-slate-900/40 p-4 rounded-xl border border-white/5",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"text-[10px] uppercase text-muted-foreground font-black tracking-widest px-1",children:"Empresa"}),e.jsxs(N,{value:v,onValueChange:s=>{D(s),s==="all"&&(L("all"),k("all"))},children:[e.jsx(I,{className:"industrial-input h-10",children:e.jsx(y,{placeholder:"Todas Empresas"})}),e.jsxs(C,{className:"glass-card",children:[e.jsx(j,{value:"all",children:"Todas Empresas"}),O.map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"text-[10px] uppercase text-muted-foreground font-black tracking-widest px-1",children:"Obra / Projeto"}),e.jsx(Le,{value:u,onValueChange:s=>{if(L(s),k("all"),s!=="all"){const a=q.find(i=>i.id===s);a&&a.companyId!==v&&D(a.companyId)}},showAll:!0,placeholder:"Todas Obras"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{className:"text-[10px] uppercase text-muted-foreground font-black tracking-widest px-1",children:"Canteiro / Unidade"}),e.jsxs(N,{value:P,onValueChange:s=>{if(k(s),s!=="all"){const a=c.find(i=>i.id===s);if(a&&a.projectId!==u){L(a.projectId);const i=q.find(t=>t.id===a.projectId);i&&i.companyId!==v&&D(i.companyId)}}},disabled:u==="all",children:[e.jsx(I,{className:"industrial-input h-10",children:e.jsx(y,{placeholder:"Todos Canteiros"})}),e.jsxs(C,{className:"glass-card",children:[e.jsx(j,{value:"all",children:"Todos Canteiros"}),c.filter(s=>u==="all"||s.projectId===u).map(s=>e.jsx(j,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(F,{placeholder:"Buscar equipes...",value:B,onChange:s=>ne(s.target.value),className:"pl-10 industrial-input h-10"})]})]}),ee.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center min-h-[400px]",children:e.jsx(We,{type:"workers",title:"Nenhuma Equipe Encontrada",description:"Você ainda não possui equipes estruturadas para suas obras atuais. Organize seus colaboradores em frentes de trabalho.",onAction:()=>S(!0),actionLabel:"Criar Primeira Equipe",hideAction:!(g.value||h("teams.create"))})}):e.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:ee.map(s=>e.jsxs(Me,{className:"glass-card hover:shadow-strong transition-all group",children:[e.jsxs(Ve,{className:"pb-3",children:[e.jsxs(ze,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Pe,{className:"w-5 h-5 text-primary"}),s.name]}),s.supervisorName&&e.jsxs($e,{className:"flex items-center gap-1.5 mt-1 font-medium text-foreground/80",children:[e.jsx(M,{className:"w-3.5 h-3.5 text-yellow-500"}),s.supervisorName]})]}),e.jsxs(Be,{children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:[s.members.length," ",s.members.length===1?"membro cadastrado":"membros cadastrados"]}),e.jsx("div",{className:"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(()=>{const a=g.value||h("teams.update"),i=g.value||h("teams.delete"),t=g.value||h("teams.manage");return!a&&!i?e.jsxs("div",{className:"flex items-center justify-center w-full py-2 text-muted-foreground/30",title:"Sem permissão no módulo Custom SU",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"text-xs uppercase font-bold",children:"Leitura"})]}):t?e.jsxs(e.Fragment,{children:[a&&e.jsxs(f,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>{const n=c.find(x=>x.id===s.siteId);R(s),m({name:s.name,supervisorId:s.supervisorId||"",members:s.members,siteId:s.siteId||"",companyId:s.companyId||(n==null?void 0:n.companyId)||"",projectId:(n==null?void 0:n.projectId)||""}),S(!0)},children:[e.jsx(ss,{className:"w-4 h-4 mr-1"}),"Editar"]}),i&&e.jsxs(f,{variant:"destructive",size:"sm",className:"flex-1",onClick:()=>ce(s),children:[e.jsx(as,{className:"w-4 h-4 mr-1"}),"Excluir"]})]}):e.jsxs("div",{className:"flex items-center justify-center w-full py-2 text-muted-foreground/30",title:"Sem permissão hierárquica",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"text-xs uppercase font-bold",children:"Bloqueado"})]})})()})]})]},s.id))}),e.jsx(Ke,{open:b.open,onOpenChange:s=>Y(a=>({...a,open:s})),title:b.title,description:b.description,onConfirm:b.onConfirm,variant:b.variant})]})}export{Es as default};
