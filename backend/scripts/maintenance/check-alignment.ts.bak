import { PrismaClient } from '@prisma/client';
import * as dotenv from 'dotenv';

dotenv.config();

const prisma = new PrismaClient();

async function main() {
    console.log('--- VERIFICAÇÃO DE ALINHAMENTO DE ETAPAS ---');
    
    // Check first 3 projects to be sure
    const projects = await prisma.project.findMany({ take: 3 });
    if (projects.length === 0) {
        console.log('Nenhum projeto encontrado.');
        return;
    }

    for (const project of projects) {
        console.log(`\nProjeto: ${project.name} (${project.id})`);

        const stages = await prisma.workStage.findMany({
            where: { site: { projectId: project.id } },
            include: { site: true }
        });

        console.log(`Etapas encontradas: ${stages.length}`);
        for (const s of stages) {
            console.log(`- [${s.id}] ${s.name} (Activity: ${s.productionActivityId})`);
            
            if (s.productionActivityId) {
                const progressCount = await prisma.mapElementProductionProgress.count({
                    where: { activityId: s.productionActivityId }
                });
                
                console.log(`  Progresso Registrado: ${progressCount} elementos`);
                
                if (progressCount > 0) {
                    const stats = await prisma.mapElementProductionProgress.aggregate({
                        where: { activityId: s.productionActivityId },
                        _avg: { progressPercent: true }
                    });
                    console.log(`  Média de Progresso: ${Number(stats._avg.progressPercent || 0).toFixed(2)}%`);
                }
            } else {
                console.log('  AVISO: Etapa sem productionActivityId vinculado.');
            }
        }
    }

    const allProgress = await prisma.mapElementProductionProgress.findMany({
        take: 3,
        include: { element: true }
    });

    console.log('\nExemplo de Progresso de Produção (Geral):');
    allProgress.forEach(p => {
        console.log(`- Element: ${p.element.objectId}, Activity: ${p.activityId}, Progress: ${p.progressPercent}%`);
    });
}

main()
    .catch(console.error)
    .finally(() => prisma.$disconnect());
