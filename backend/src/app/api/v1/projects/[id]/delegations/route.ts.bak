import { NextRequest } from "next/server";
import { ApiResponse, handleApiError } from "@/lib/utils/api/response";
import { requireAuth, isUserAdmin } from "@/lib/auth/session";
import { DelegationService } from "@/modules/projects/application/delegation.service";
import { z } from "zod";

const delegationService = new DelegationService();

const delegationSchema = z.object({
  jobFunctionId: z.string(),
  moduleId: z.string(),
  isGranted: z.boolean().default(true),
});

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } },
) {
  try {
    const user = await requireAuth();
    const projectId = (await params).id;

    // Apenas o Gestor do Projeto ou Admin pode ver as delegações
    if (user.role !== "GESTOR_PROJECT" && !isUserAdmin(user.role)) {
      return ApiResponse.forbidden("Acesso restrito ao Gestor do Projeto");
    }

    const delegations = await delegationService.listDelegations(projectId);
    return ApiResponse.json(delegations);
  } catch (error: any) {
    return handleApiError(error);
  }
}

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } },
) {
  try {
    const user = await requireAuth();
    const projectId = (await params).id;

    // Apenas o Gestor do Projeto ou Admin pode delegar poderes
    if (user.role !== "GESTOR_PROJECT" && !isUserAdmin(user.role)) {
      return ApiResponse.forbidden("Acesso restrito ao Gestor do Projeto");
    }

    const body = await request.json();
    const validation = delegationSchema.safeParse(body);

    if (!validation.success) {
      return ApiResponse.badRequest("Dados de delegação inválidos");
    }

    const result = await delegationService.applyDelegation({
      ...validation.data,
      projectId,
      grantedById: user.id,
    });

    return ApiResponse.json(result, "Permissão delegada com sucesso");
  } catch (error: any) {
    return handleApiError(error);
  }
}
