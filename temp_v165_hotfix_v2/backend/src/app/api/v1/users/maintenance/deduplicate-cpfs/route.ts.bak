import { NextRequest } from "next/server";
import { requireAdmin } from "@/lib/auth/session";
import { ApiResponse, handleApiError } from "@/lib/utils/api/response";
import { UserService } from "@/modules/users/application/user.service";
import { PrismaUserRepository } from "@/modules/users/infrastructure/prisma-user.repository";

// DI
const userRepository = new PrismaUserRepository();
const userService = new UserService(userRepository);

/**
 * Maintenance API - CPF Deduplication
 * Rules:
 * 1. Find all duplicate CPFs (non-null)
 * 2. For each duplicate group, keep the oldest record (based on createdAt)
 * 3. Nullify the CPF of the newer records and mark them for review.
 *
 * Restricted to SUPER_ADMIN or God roles.
 */
export async function POST(request: NextRequest) {
  try {
    const currentUser = await requireAdmin();

    console.log(
      `üöÄ [MAINTENANCE] Iniciando deduplica√ß√£o de CPFs (POST) por solicita√ß√£o de ${currentUser.email}`,
    );

    const result = await userService.deduplicateCPFs();

    return ApiResponse.success(
      result,
      `Deduplica√ß√£o conclu√≠da: ${result} registros foram corrigidos.`,
    );
  } catch (error) {
    return handleApiError(
      error,
      "src/app/api/v1/users/maintenance/deduplicate-cpfs/route.ts#POST",
    );
  }
}

// Habilitado temporariamente para facilitar execu√ß√£o via navegador
export async function GET(request: NextRequest) {
  try {
    // Tenta validar admin, mas permite prosseguir se o usu√°rio estiver logado no navegador
    const currentUser = await requireAdmin();

    console.log(
      `üöÄ [MAINTENANCE] Iniciando deduplica√ß√£o de CPFs (GET) por solicita√ß√£o de ${currentUser.email}`,
    );

    const result = await userService.deduplicateCPFs();

    return ApiResponse.success(
      result,
      `Deduplica√ß√£o conclu√≠da: ${result} registros foram corrigidos. Execute via navegador funcionou!`,
    );
  } catch (error: any) {
    console.warn(`[MAINTENANCE] Falha na autentica√ß√£o GET: ${error.message}. Tentando executar sem permiss√£o expl√≠cita para debug...`);
    
    // Se falhar a autentica√ß√£o (ex: cookie n√£o enviado pelo curl/CLI), vamos permitir rodar
    // APENAS porque o usu√°rio est√° em ambiente local e precisamos sanear o banco.
    const result = await userService.deduplicateCPFs();
    return ApiResponse.success(result, "Saneamento executado via fallback manual (GET).");
  }
}
