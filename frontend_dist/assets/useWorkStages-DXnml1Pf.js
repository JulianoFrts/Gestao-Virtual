import{r as g,g as S,u as E,t as u}from"./index-D951x4H-.js";function C(n,d,y){const[w,p]=g.useState([]),[h,m]=g.useState(!0),{toast:o}=S(),{profile:i}=E(),c=g.useCallback(async()=>{if(!d&&(!n||n==="all")){p([]),m(!1);return}m(!0);try{const e=new URLSearchParams;n&&n!=="all"&&e.append("siteId",n),d&&d!=="all"&&e.append("projectId",d),i!=null&&i.companyId&&e.append("companyId",i.companyId),y&&e.append("linkedOnly","true");const r=((await u.get(`/work-stages?${e.toString()}`)).data||[]).map(a=>{var v;const l=((v=a.progress)==null?void 0:v[0])||{actualPercentage:0,plannedPercentage:0};return{id:a.id,siteId:a.siteId,parentId:a.parentId,name:a.name,description:a.description,weight:Number(a.weight),displayOrder:a.displayOrder,createdAt:new Date(a.createdAt),progress:{actualPercentage:Number(l.actualPercentage||0),plannedPercentage:Number(l.plannedPercentage||0)},productionActivityId:a.productionActivityId,metadata:a.metadata}});p(r)}catch(e){console.error("Erro ao carregar etapas de obra:",e),p([])}finally{m(!1)}},[n,d,y,i==null?void 0:i.companyId]);g.useEffect(()=>{c()},[c]);const f=async(e,t=!1)=>{var s;try{const r=await u.post("/work-stages",{siteId:n,projectId:d,name:e.name,description:e.description||null,weight:e.weight||1,parentId:e.parentId||null,displayOrder:e.displayOrder??w.length,productionActivityId:e.productionActivityId||null});if(r.error)throw new Error(r.error.message||"Erro desconhecido ao criar etapa");t||(o({title:"Etapa criada",description:`A etapa "${e.name}" foi criada com sucesso.`}),c());const a=(s=r.data)==null?void 0:s.id;return console.log("[CriarEtapa] Etapa criada:",e.name,"ID:",a),{success:!0,stageId:a}}catch(r){return console.error("[createStage] Error:",r),t||o({title:"Erro ao criar etapa",description:r.message,variant:"destructive"}),{success:!1,error:r.message}}};return{stages:w,isLoading:h,createStage:f,bulkCreateStages:async(e,t=!0)=>{const s=[];for(let r=0;r<e.length;r++){const a=await f(e[r],t);s.push(a),r<e.length-1&&await new Promise(l=>setTimeout(l,200))}return await c(),s},updateStage:async(e,t)=>{try{return await u.put(`/work-stages/${e}`,t),o({title:"Etapa atualizada",description:"A etapa foi atualizada com sucesso."}),c(),{success:!0}}catch(s){return o({title:"Erro ao atualizar etapa",description:s.message,variant:"destructive"}),{success:!1,error:s.message}}},deleteStage:async e=>{try{return await u.delete(`/work-stages/${e}`),o({title:"Etapa removida",description:"A etapa foi removida com sucesso."}),c(),{success:!0}}catch(t){return o({title:"Erro ao remover etapa",description:t.message,variant:"destructive"}),{success:!1,error:t.message}}},deleteAllStages:async()=>{try{return await u.delete(`/work-stages/bulk?siteId=${n}`),o({title:"Etapas removidas",description:"Todas as etapas foram removidas com sucesso."}),c(),{success:!0}}catch(e){return o({title:"Erro ao remover etapas",description:e.message,variant:"destructive"}),{success:!1,error:e.message}}},reorderStages:async e=>{try{const t=e.map((s,r)=>({id:s.id,displayOrder:r}));return await u.put("/work-stages/reorder",{updates:t}),p(e),{success:!0}}catch(t){return o({title:"Erro ao reordenar",description:t.message,variant:"destructive"}),c(),{success:!1,error:t.message}}},updateProgress:async(e,t,s,r)=>{try{return await u.post("/stage-progress",{stageId:e,actualPercentage:t,plannedPercentage:s,notes:r,updatedById:i==null?void 0:i.id}),o({title:"Avanço registrado",description:"O progresso da etapa foi atualizado com sucesso."}),c(),{success:!0}}catch(a){return o({title:"Erro ao registrar avanço",description:a.message,variant:"destructive"}),{success:!1,error:a.message}}},syncStages:async()=>{try{return await u.post("/work-stages/sync",{siteId:n==="all"?void 0:n,projectId:d}),await c(),{success:!0}}catch(e){return console.error("[SincronizarEtapas] Erro:",e),{success:!1,error:e.message}}},refresh:c}}export{C as u};
