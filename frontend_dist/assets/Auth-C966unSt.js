import{r as s,af as ee,g as _,j as e,p as N,K as X,R as q,M as se,B as n,L as C,O as R,cc as I,s as B,b0 as $,u as ae,a as te,cd as Q,ce as G,D as re,h as ie,k as le,l as ne,m as oe,o as ce}from"./index-D951x4H-.js";import{I as w}from"./input-dNnkIPn6.js";import{C as de,b as me,c as ue,d as xe,a as he}from"./card-BTHGlYFz.js";import{Q as fe,S as pe,P as ge}from"./index-LiCGkmGi.js";import{C as z}from"./circle-alert-BlgUQYiE.js";import{L as Y}from"./lock-BtTOdZOV.js";import{E as je}from"./eye-off-Bbweex62.js";import{E as ve}from"./eye-CxUjXe8h.js";import{T as Ne,a as we,b as H,c as W}from"./tabs-D3Kawp4S.js";import{A as K}from"./arrow-left-CQFd9_U_.js";function be(){const[g,S]=s.useState(""),[a,x]=s.useState(""),[c,E]=s.useState(""),[j,k]=s.useState(!1),{sendMessage:r}=ee(),{toast:d}=_(),b=async h=>{h.preventDefault(),k(!0);try{(await r({type:"PASSWORD_RESET",subject:`Redefinição de Senha - ${a}`,content:`Solicitação de redefinição de senha.

Nome: ${a}
E-mail: ${g}
Identificação: ${c}`,senderEmail:g,recipientRole:"admin",metadata:{source:"login_screen",fullName:a,email:g,identification:c}})).success&&(d({title:"Solicitação Enviada",description:"Sua solicitação foi registrada. Um administrador analisará e entrará em contato."}),S(""),x(""),E(""))}catch{d({title:"Erro",description:"Não foi possível enviar a solicitação.",variant:"destructive"})}finally{k(!1)}};return e.jsxs("form",{onSubmit:b,className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{htmlFor:"reset-name",className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-3 h-3"}),"Nome Completo *"]}),e.jsx(w,{id:"reset-name",type:"text",placeholder:"Seu nome completo",value:a,onChange:h=>x(h.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{htmlFor:"reset-email",className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-3 h-3"}),"E-mail Cadastrado *"]}),e.jsx(w,{id:"reset-email",type:"email",placeholder:"seu@email.com",value:g,onChange:h=>S(h.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{htmlFor:"reset-ident",className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-3 h-3"}),"Empresa / Obra / Canteiro *"]}),e.jsx(w,{id:"reset-ident",placeholder:"Ex: Construtora XYZ - Obra Alpha",value:c,onChange:h=>E(h.target.value),required:!0}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Necessário para validação de identidade."})]}),e.jsxs(n,{type:"submit",className:"w-full gradient-primary",disabled:j||!g||!a||!c,children:[j?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):null,"Enviar Solicitação"]})]})}function ye({onSuccess:g,onCancel:S}){const[a,x]=s.useState("email"),[c,E]=s.useState(""),[j,k]=s.useState(""),[r,d]=s.useState(""),[b,h]=s.useState(""),[o,D]=s.useState(!1),[m,f]=s.useState(!1),[v,l]=s.useState(null),{toast:O}=_(),T=async i=>{i.preventDefault(),f(!0),l(null);try{const y=(await $.post("/auth/check-mfa-status",{identifier:c})).data;if(!y.found){l("E-mail não encontrado no sistema.");return}if(!y.hasMfa){l('Este e-mail não possui MFA habilitado. Use a opção "Solicitar redefinição" para contatar um administrador.');return}x("verify")}catch{l("Erro ao verificar e-mail. Tente novamente.")}finally{f(!1)}},A=async i=>{if(i.preventDefault(),j.length===6){f(!0),l(null);try{x("newPassword")}catch{l("Código MFA inválido.")}finally{f(!1)}}},P=async i=>{var M,y;if(i.preventDefault(),f(!0),l(null),r.length<6){l("A senha deve ter no mínimo 6 caracteres."),f(!1);return}if(r!==b){l("As senhas não coincidem."),f(!1);return}try{const u=await $.post("/auth/recover-password-2fa",{email:c,mfaCode:j,newPassword:r});u.data.success?(x("success"),O({title:"Senha alterada com sucesso!",description:"Você já pode fazer login com sua nova senha."})):l(u.data.error||"Código MFA inválido ou expirado.")}catch(u){const V=u;l(((y=(M=V==null?void 0:V.response)==null?void 0:M.data)==null?void 0:y.error)||"Erro ao alterar senha. Tente novamente.")}finally{f(!1)}},F=r===b&&b.length>0,L=r.length>=6;return e.jsxs("div",{className:"space-y-4 pt-4",children:[a==="email"&&e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx(R,{className:"w-12 h-12 mx-auto text-primary mb-2"}),e.jsx("h3",{className:"font-semibold text-lg",children:"Recuperação via 2FA"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Disponível apenas para contas com autenticação em dois fatores habilitada."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{htmlFor:"recovery-email",className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-3 h-3"}),"E-mail da Conta"]}),e.jsx(w,{id:"recovery-email",type:"email",placeholder:"seu@email.com",value:c,onChange:i=>{E(i.target.value),l(null)},required:!0,autoFocus:!0})]}),v&&e.jsxs("div",{className:"p-3 rounded-lg bg-destructive/10 border border-destructive/30 flex items-start gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-destructive mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm text-destructive",children:v})]}),e.jsxs(n,{type:"submit",className:"w-full gradient-primary",disabled:m||!c,children:[m?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):null,"Verificar Conta"]}),S&&e.jsx(n,{type:"button",variant:"ghost",className:"w-full",onClick:S,children:"Cancelar"})]}),a==="verify"&&e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx(R,{className:"w-12 h-12 mx-auto text-green-500 mb-2"}),e.jsx("h3",{className:"font-semibold text-lg",children:"Código de Verificação"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Insira o código de 6 dígitos do seu aplicativo autenticador."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"mfa-code",className:"text-center block",children:"Código MFA"}),e.jsx(w,{id:"mfa-code",type:"text",placeholder:"000 000",value:j,onChange:i=>k(i.target.value.replace(/\D/g,"").slice(0,6)),className:"text-center text-2xl tracking-[0.5em] font-bold h-14",required:!0,autoFocus:!0})]}),v&&e.jsx("div",{className:"p-3 rounded-lg bg-destructive/10 border border-destructive/30",children:e.jsx("p",{className:"text-sm text-destructive text-center",children:v})}),e.jsxs(n,{type:"submit",className:"w-full gradient-primary",disabled:m||j.length!==6,children:[m?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):null,"Verificar Código"]}),e.jsx(n,{type:"button",variant:"ghost",className:"w-full",onClick:()=>x("email"),children:"Voltar"})]}),a==="newPassword"&&e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx(Y,{className:"w-12 h-12 mx-auto text-primary mb-2"}),e.jsx("h3",{className:"font-semibold text-lg",children:"Nova Senha"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Defina uma nova senha para sua conta."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"new-password",children:"Nova Senha (mínimo 6 caracteres)"}),e.jsxs("div",{className:"relative",children:[e.jsx(w,{id:"new-password",type:o?"text":"password",placeholder:"••••••••",value:r,onChange:i=>d(i.target.value),required:!0,minLength:6,className:"pr-10",autoFocus:!0}),e.jsx("button",{type:"button",className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground",onClick:()=>D(!o),children:o?e.jsx(je,{className:"w-4 h-4"}):e.jsx(ve,{className:"w-4 h-4"})})]}),r.length>0&&e.jsxs("div",{className:B("text-xs flex items-center gap-1",L?"text-green-500":"text-amber-500"),children:[L?e.jsx(I,{className:"w-3 h-3"}):e.jsx(z,{className:"w-3 h-3"}),L?"Senha válida":"Mínimo 6 caracteres"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"confirm-password",children:"Confirmar Senha"}),e.jsx(w,{id:"confirm-password",type:o?"text":"password",placeholder:"••••••••",value:b,onChange:i=>h(i.target.value),required:!0}),b.length>0&&e.jsxs("div",{className:B("text-xs flex items-center gap-1",F?"text-green-500":"text-destructive"),children:[F?e.jsx(I,{className:"w-3 h-3"}):e.jsx(z,{className:"w-3 h-3"}),F?"Senhas coincidem":"Senhas não coincidem"]})]}),v&&e.jsx("div",{className:"p-3 rounded-lg bg-destructive/10 border border-destructive/30",children:e.jsx("p",{className:"text-sm text-destructive text-center",children:v})}),e.jsxs(n,{type:"submit",className:"w-full gradient-primary",disabled:m||!L||!F,children:[m?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):null,"Alterar Senha"]}),e.jsx(n,{type:"button",variant:"ghost",className:"w-full",onClick:()=>x("verify"),children:"Voltar"})]}),a==="success"&&e.jsxs("div",{className:"text-center space-y-4 py-6",children:[e.jsx(I,{className:"w-16 h-16 mx-auto text-green-500"}),e.jsx("h3",{className:"font-bold text-xl text-green-500",children:"Senha Alterada!"}),e.jsx("p",{className:"text-muted-foreground",children:"Sua senha foi alterada com sucesso. Você já pode fazer login."}),e.jsx(n,{className:"w-full gradient-primary",onClick:()=>g==null?void 0:g(),children:"Fazer Login"})]})]})}function Oe(){const[g,S]=s.useState(!1),[a,x]=s.useState("login"),[c,E]=s.useState(""),[j,k]=s.useState(""),[r,d]=s.useState(!1),[b,h]=s.useState(""),[o,D]=s.useState(!1),[m,f]=s.useState(""),[v,l]=s.useState(null),[O,T]=s.useState(!navigator.onLine),[A,P]=s.useState(null),{login:F,loginOffline:L,getLastOfflineAccount:i,setMfaVerified:M}=ae(),y=te(),{toast:u}=_();s.useEffect(()=>{const t=()=>T(!1),p=()=>T(!0);return window.addEventListener("online",t),window.addEventListener("offline",p),i().then(U=>{U&&P(U)}),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",p)}},[i]),s.useEffect(()=>{if(a==="qr"){const t=`ttpro_link_${Math.random().toString(36).substring(7)}_${Date.now()}`;h(t)}},[a]);const V=async t=>{t.preventDefault(),d(!0),S(!0);try{const p=await F(c,j);if(p.success){if(setTimeout(()=>{d(!1)},500),p.mfaRequired&&p.profile){l(p.profile),D(!0),u({title:"MFA Requerido",description:"Insira o código do seu autenticador."});return}u({title:"Login realizado!",description:"Bem-vindo ao GESTÃO VIRTUAL"}),y("/dashboard"),M(!0)}else u({title:"Erro no login",description:p.error,variant:"destructive"})}finally{d(!1)}},Z=async()=>{d(!0);try{const t=await L();t.success?(u({title:"Login Offline Realizado!",description:"Você está acessando em modo offline."}),y("/dashboard")):u({title:"Erro no login offline",description:t.error,variant:"destructive"})}finally{d(!1)}},J=async t=>{if(t.preventDefault(),!(m.length!==6||!v)){d(!0);try{const p=await ge({token:m,secret:v.mfaSecret});console.log("MFA Login Verification:",{codeReceived:m,isValid:p.valid,secretUsed:v.mfaSecret.substring(0,4)+"..."}),p.valid?(M(!0),u({title:"Segurança validada!",description:"Acesso concedido."}),y("/dashboard")):u({title:"Código incorreto",description:"O código TOTP inserido é inválido ou expirou.",variant:"destructive"})}finally{d(!1)}}};return e.jsx("div",{className:"min-h-screen dark theme-industrial gradient-hero flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-lg animate-fade-in flex flex-col items-center",children:[e.jsx("div",{className:"text-center mb-0 flex flex-col items-center",children:e.jsx("img",{src:"/logo-orion.png",alt:"Orion Logo",className:"w-[450px] md:w-[500px] h-auto drop-shadow-[0_0_25px_rgba(255,255,255,0.2)] animate-in fade-in zoom-in duration-1000"})}),e.jsxs(de,{className:"glass-card border-foreground/10 relative overflow-hidden w-full max-w-md -mt-6",children:[a==="qr"&&e.jsx("div",{className:"absolute -top-24 -right-24 w-48 h-48 bg-primary/20 rounded-full blur-3xl animate-pulse"}),e.jsxs(me,{className:"text-center",children:[e.jsxs(ue,{className:"text-2xl font-bold flex items-center justify-center gap-2 text-foreground",children:[o?"Verificação MFA":a==="login"?"Bem-vindo":"Acesso Rápido",(a==="qr"||o)&&(o?e.jsx(R,{className:"w-6 h-6 text-primary"}):e.jsx(Q,{className:"w-6 h-6 text-primary"}))]}),e.jsx(xe,{className:"text-foreground/70",children:o?"Insira o código de 6 dígitos do Microsoft Authenticator":a==="login"?"Entre com suas credenciais":"Use seu celular para entrar"})]}),e.jsxs(he,{children:[o?e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"mfa-code",className:"text-foreground/80 font-semibold uppercase text-[10px] tracking-wider text-center block",children:"Código de Segurança"}),e.jsx(w,{id:"mfa-code",type:"text",placeholder:"000 000",value:m,onChange:t=>f(t.target.value.replace(/\D/g,"").slice(0,6)),className:"text-center text-3xl tracking-[0.5em] font-bold h-16 dark:industrial-input-dark",required:!0,autoFocus:!0})]}),e.jsx(n,{type:"submit",className:"w-full h-11 gradient-primary text-primary-foreground font-bold shadow-glow",disabled:r||m.length!==6,children:r?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):"Verificar e Entrar"}),e.jsxs(n,{type:"button",variant:"ghost",className:"w-full text-xs text-muted-foreground",onClick:()=>{D(!1),f("")},children:[e.jsx(K,{className:"w-3 h-3 mr-2"})," Voltar ao login"]})]}):a==="login"?e.jsxs(e.Fragment,{children:[O&&A&&e.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-amber-500/10 border border-amber-500/30",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-500 mb-2",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold text-sm",children:"Modo Offline"})]}),e.jsx("p",{className:"text-xs text-foreground/70 mb-3",children:"Sem conexão com a internet. Você pode continuar como:"}),e.jsxs(n,{onClick:Z,disabled:r,className:"w-full bg-amber-600 hover:bg-amber-700 text-white",children:[r?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(X,{className:"w-4 h-4 mr-2"}),"Entrar como ",A.fullName]}),e.jsxs("p",{className:"text-[10px] text-foreground/50 mt-2 text-center",children:["(",A.identifier,")"]})]}),O&&!A&&e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-destructive/10 border border-destructive/30",children:[e.jsxs("div",{className:"flex items-center gap-2 text-destructive",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"font-semibold text-sm",children:"Sem Conexão"})]}),e.jsx("p",{className:"text-xs text-foreground/70 mt-1",children:"É necessário estar online para o primeiro login."})]}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"email",className:"text-foreground/80 font-semibold uppercase text-[10px] tracking-wider",children:"Usuário ou E-mail"}),e.jsxs("div",{className:"relative group",children:[e.jsx(q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-foreground/40 group-focus-within:text-primary transition-colors"}),e.jsx(w,{id:"email",type:"text",placeholder:"E-mail ou Matrícula (#12345678)",value:c,onChange:t=>E(t.target.value),className:"pl-10 dark:industrial-input-dark",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"password",title:"password label",className:"text-foreground/80 font-semibold uppercase text-[10px] tracking-wider",children:"Senha de Acesso"}),e.jsxs("div",{className:"relative group",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-foreground/40 group-focus-within:text-primary transition-colors"}),e.jsx(w,{id:"password",type:"password",placeholder:"••••••••",value:j,onChange:t=>k(t.target.value),className:"pl-10  dark:industrial-input-dark",required:!0,minLength:6,autoComplete:"current-password"})]})]}),e.jsx(n,{type:"submit",className:"w-full h-11 gradient-primary text-primary-foreground font-bold shadow-glow hover:scale-[1.02] active:scale-[0.98] transition-all duration-200",disabled:r,children:r?e.jsx(C,{className:"w-4 h-4 animate-spin mr-2"}):"Entrar no Sistema"}),e.jsx("div",{className:"text-center mt-2",children:e.jsxs(re,{children:[e.jsx(ie,{asChild:!0,children:e.jsx(n,{variant:"link",className:"text-xs text-muted-foreground hover:text-primary",children:"Esqueceu sua senha? Solicitar redefinição"})}),e.jsxs(le,{className:"sm:max-w-md",children:[e.jsxs(ne,{children:[e.jsx(oe,{children:"Recuperação de Senha"}),e.jsx(ce,{children:"Escolha como deseja recuperar sua senha."})]}),e.jsxs(Ne,{defaultValue:"2fa",className:"w-full",children:[e.jsxs(we,{className:"grid w-full grid-cols-2",children:[e.jsxs(H,{value:"2fa",className:"text-xs",children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),"Via 2FA"]}),e.jsxs(H,{value:"admin",className:"text-xs",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Via Administrador"]})]}),e.jsx(W,{value:"2fa",children:e.jsx(ye,{onSuccess:()=>{}})}),e.jsx(W,{value:"admin",children:e.jsx(be,{})})]})]})]})})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-4 space-y-6 animate-scale-in",children:[e.jsx("div",{className:"p-4 bg-white rounded-3xl shadow-glow overflow-hidden",children:e.jsx(fe,{value:b,size:220,level:"H",includeMargin:!0})}),e.jsxs("div",{className:"text-center space-y-3 px-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary font-semibold",children:[e.jsx(pe,{className:"w-5 h-5"}),e.jsx("span",{children:"Sincronizar Dispositivo"})]}),e.jsx("p",{className:"text-sm text-foreground/60 leading-relaxed font-medium",children:"Escaneie para vincular seu telefone e habilitar o login biométrico e geolocalização."})]}),e.jsxs(n,{variant:"ghost",className:"text-foreground/60 hover:text-foreground hover:bg-foreground/5 font-semibold",onClick:()=>x("login"),children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Voltar ao login comum"]})]}),e.jsx("div",{className:"mt-8 border-t border-foreground/5 pt-6 text-center",children:a==="login"&&!o&&e.jsxs("button",{type:"button",onClick:()=>x("qr"),className:"text-primary hover:text-primary/80 flex items-center justify-center gap-2 w-full font-black text-xs tracking-widest transition-colors",children:[e.jsx(Q,{className:"w-4 h-4"}),"LOGIN VIA QR CODE"]})})]})]})]})})}export{Oe as default};
