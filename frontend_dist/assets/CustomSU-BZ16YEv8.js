import{f as Ss,r as d,aA as rs,j as e,B as h,q as Ee,a_ as Be,F as ts,D as de,k as me,l as he,m as xe,o as Te,p as R,aS as ue,a$ as c,W as zs,u as Ds,g as Es,i as Ts,b0 as A,L as Oe,ay as As,aj as Ms,a4 as He,s as Ie,ah as Ps,S as Ve,G as Xe,H as Ge,I as Ke,at as Je,J as Qe,ag as Fs,b1 as Re}from"./index-D951x4H-.js";import{C as is,b as ns,c as Os,d as ls,a as os}from"./card-BTHGlYFz.js";import{C as X}from"./checkbox-B9hZgst_.js";import{T as cs,a as ds,b as K,c as G,d as ms,e as M}from"./table-UwE0Vej1.js";import{T as Is,a as Rs,b as We,c as Ze}from"./tabs-D3Kawp4S.js";import{u as $s,a as _s,D as Ls,F as Us}from"./permission-modal-BEhDpYqz.js";import{I as q}from"./input-dNnkIPn6.js";import{A as ve,a as ye,b as be,c as we,d as Ce,e as ke,f as Se,g as ze}from"./alert-dialog-qR-bbYaw.js";import{D as De}from"./download-L1tB_Hhn.js";import{T as ce}from"./trash-2-DD2QlM38.js";import{U as qs}from"./upload-D2Q7C-3S.js";import{E as Bs}from"./eye-CxUjXe8h.js";import{P as Hs}from"./pen-C5GdyZXe.js";import{A as Vs}from"./archive-BPtJUZpO.js";import{I as hs}from"./info-MbzHf59N.js";import{f as Ye}from"./format-CP1OFCPJ.js";import{P as es}from"./plus-DmkF01H_.js";import{S as ss}from"./save-BcLL5Pf6.js";import"./index-COevDGDX.js";import"./context-menu-CftfI8l1.js";import"./scroll-area-C9sC2RNd.js";import"./activity-BYx2dwgt.js";import"./ellipsis-CNuBxG9Z.js";import"./search-BoEw84GM.js";import"./list-BniZwJ04.js";import"./lock-BtTOdZOV.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xs=[["path",{d:"M2 9V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1",key:"fm4g5t"}],["path",{d:"M2 13h10",key:"pgb2dq"}],["path",{d:"m9 16 3-3-3-3",key:"6m91ic"}]],as=Ss("FolderInput",Xs);function Gs(){const{documents:v,isLoading:p,uploadDocument:P,updateDocument:J,downloadDocument:y,previewDocument:se,createFolder:b,deleteDocument:$,refresh:B}=$s(),{addToQueue:ae,isProcessing:re,currentDownload:Q,queueLength:pe}=_s(y),[H,Ae]=d.useState(""),[S,z]=d.useState(null),[g,w]=d.useState([]),[te,F]=d.useState(null),_=rs.useRef(null),[D,V]=d.useState(!1),[C,ie]=d.useState(null),[E,T]=d.useState(!1),[ne,fe]=d.useState(""),[Me,Pe]=d.useState("/"),[Fe,W]=d.useState(!1),[le,oe]=d.useState(""),[ge,je]=d.useState(null),[a,i]=d.useState(!1),[l,m]=d.useState(null),[j,N]=d.useState(!1),[L,U]=d.useState(!1),[O,Z]=d.useState(!1),[k,Y]=d.useState(null),xs=async()=>{N(!1);const s=[{name:"01. Empresa",path:"/"},{name:"02. Obra",path:"/"},{name:"03. Canteiro",path:"/"}];c.loading("Criando estrutura base...");try{for(const r of s)v.some(n=>{var o;return(n.docType==="folder"||((o=n.fileUrl)==null?void 0:o.includes("folder")))&&n.name===r.name&&n.folderPath===r.path})||await b(r.name,r.path);c.dismiss(),c.success("Estrutura criada com sucesso!")}catch{c.dismiss(),c.error("Erro ao criar estrutura.")}},us=async()=>{U(!1);const s=v.filter(r=>{var t;return r.folderPath==="/"&&r.docType!=="folder"&&!((t=r.fileUrl)!=null&&t.includes("folder"))});if(s.length!==0){c.loading("Analisando e organizando arquivos...");try{const r=[{name:"03. Canteiro",match:o=>!!o.siteId},{name:"02. Obra",match:o=>!!o.projectId&&!o.siteId},{name:"01. Empresa",match:o=>!o.projectId&&!o.siteId}];let t=0;const n=new Set;for(const o of r){const x=s.filter(f=>o.match(f)&&!n.has(f.id));if(x.length===0)continue;let u=v.find(f=>{var I;return(f.docType==="folder"||((I=f.fileUrl)==null?void 0:I.includes("folder")))&&f.name===o.name&&f.folderPath==="/"});if(!u){const f=await b(o.name,"/");f!=null&&f.data&&(u=f.data)}if(u){const f=`/${u.id}/`;for(const I of x)await J(I.id,{folderPath:f}),n.add(I.id),t++}}c.dismiss(),c.success(`${t} arquivos organizados!`),B()}catch{c.dismiss(),c.error("Erro ao organizar arquivos.")}}},$e=()=>{var s;(s=_.current)==null||s.click()},ps=async s=>{var t;const r=(t=s.target.files)==null?void 0:t[0];r&&(c.promise(P(r,{}),{loading:"Enviando documento SU...",success:"Documento enviado com sucesso!",error:"Erro ao enviar documento"}),_.current&&(_.current.value=""))},Ne=20,_e=100,fs=()=>{const s=v.filter(t=>t.fileUrl!=="folder");if(s.length===0){c.error("Nenhum documento para exportar.");return}if(s.length>Ne){c.error(`Muitos arquivos (${s.length}). Limite: ${Ne}`);return}if(s.reduce((t,n)=>t+(n.fileSize||0),0)/(1024*1024)>_e){c.error("Tamanho total excede o limite de 100MB.");return}ae(s)},gs=()=>{const s=v.filter(t=>g.includes(t.id)&&t.fileUrl!=="folder");if(s.length===0)return;if(s.length>Ne){c.error(`Selecione no máximo ${Ne} arquivos.`);return}if(s.reduce((t,n)=>t+(n.fileSize||0),0)/(1024*1024)>_e){c.error("Tamanho selecionado excede 100MB.");return}ae(s)},js=(s="/")=>{Pe(typeof s=="string"?s:"/"),fe(""),T(!0)},Le=async()=>{ne.trim()&&(T(!1),await b(ne,Me))},Ns=async(s,r="Padrao")=>{const t=r.replace(/^\d+\.\s*/,""),n={"template-obra":["01. Projetos","02. Torres","03. Relatórios","04. Fotos"],"template-canteiro":["01. Funcionários","02. Documentos Funcionários","03. EPIs","04. Treinamentos"],"template-su":["01. Empresa","02. Obra","03. Canteiro"],root:["01. Empresa","02. Obra","03. Canteiro"],Obra:["Torres","Projetos","Diários"],Canteiro:["Funcionários","Documentos"],Padrao:["Docs","Configs","Backups"]},o=n[s]||n[t]||n[r]||n.Padrao,x=s.startsWith("template-")||s==="root"?"/":`/${s}/`;c.loading("Criando estrutura SU...");try{await Promise.all(o.map(u=>b(u,x))),c.dismiss(),c.success("Estrutura SU sincronizada e criada!"),B()}catch{c.dismiss(),c.error("Erro ao criar estrutura.")}},vs=(s,r)=>{const t=v.find(n=>n.id===r.id);if(s==="Abrir")r.type==="file"?(z(r),t&&se(t)):(z(r),c.info(`Nível/Pasta "${r.name}" selecionado`));else if(s==="Visualizar")t&&se(t);else if(s==="Renomear")t&&(je(t.id),oe(t.name),W(!0));else if(s==="Informações"){if(t){const n=`Nome: ${t.name}
Tipo: ${t.docType}
Caminho: ${t.folderPath}
Modificado: ${Ye(new Date(t.updatedAt),"dd/MM/yyyy HH:mm")}`;Y({title:"Detalhes do Arquivo",body:n})}}else s==="Excluir"?(m({id:r.id,name:r.name,storagePath:t==null?void 0:t.fileUrl}),i(!0)):s==="Nova Pasta Inteligente"?Ns(r.id,r.name):s==="Mover para Raiz"?qe(r.id,"root"):s==="Permissões"&&t&&(ie(t),V(!0))},ys=async(s,r)=>{const n=["01. Empresa","02. Obra","03. Canteiro"].includes(C.name),o={metadata:{...C.metadata,...r}};if(n&&window.confirm(`Esta é uma pasta padrão. Deseja aplicar estas permissões para TODAS as pastas "${C.name}" em todos os projetos?`)){c.loading(`Sincronizando permissões para ${C.name}...`);const{error:u}=await zs.from("construction_documents").update(o).eq("file_url","folder").eq("name",C.name);u?(c.dismiss(),c.error("Erro ao sincronizar permissões.")):(c.dismiss(),c.success("Permissões sincronizadas globalmente!"),B());return}await J(s,o)},Ue=async()=>{!ge||!le.trim()||(W(!1),c.promise(J(ge,{name:le}),{loading:"Renomeando...",success:"Renomeado com sucesso!",error:"Erro ao renomear"}),je(null))},bs=async(s,r)=>{i(!1),await $(s,r)},ws=async()=>{Z(!1);const s=g.length;c.loading(`Excluindo ${s} itens...`);try{await Promise.all(g.map(r=>{const t=v.find(n=>n.id===r);return $(r,t==null?void 0:t.fileUrl)})),c.dismiss(),c.success(`${s} itens removidos com sucesso!`),w([]),B()}catch{c.dismiss(),c.error("Erro ao excluir alguns itens.")}},qe=async(s,r)=>{const t=r==="root"||!r?"/":`/${r}/`;c.promise(J(s,{folderPath:t}),{loading:"Movendo...",success:"Movido!",error:"Erro"})},Cs=(s,r)=>{if(!s.target.closest("button"))if(s.ctrlKey||s.metaKey)w(t=>t.includes(r)?t.filter(n=>n!==r):[...t,r]),F(r);else if(s.shiftKey&&te){const t=ee,n=t.findIndex(x=>x.id===r),o=t.findIndex(x=>x.id===te);if(n!==-1&&o!==-1){const x=Math.min(n,o),u=Math.max(n,o),f=t.slice(x,u+1).map(I=>I.id);w(I=>Array.from(new Set([...I,...f])))}}else w([r]),F(r)},ee=v.filter(s=>{var t;if(s.docType==="folder"||(t=s.fileUrl)!=null&&t.includes("folder"))return!1;const r=s.name.toLowerCase().includes(H.toLowerCase());return S?S.type==="folder"?r&&s.folderPath.includes(S.id):s.id===S.id:r}),ks=s=>{const r=[],t={};return s.filter(n=>{var o;return n.docType==="folder"||((o=n.fileUrl)==null?void 0:o.includes("folder"))}).sort((n,o)=>n.name.localeCompare(o.name)).forEach(n=>{t[n.id]={id:n.id,name:n.name,type:"folder",children:[]}}),s.filter(n=>{var o;return n.docType==="folder"||((o=n.fileUrl)==null?void 0:o.includes("folder"))}).forEach(n=>{var u;const o=t[n.id],x=n.folderPath.split("/").filter(Boolean).pop();x&&t[x]?(u=t[x].children)==null||u.push(o):r.push(o)}),s.filter(n=>{var o;return n.docType!=="folder"&&!((o=n.fileUrl)!=null&&o.includes("folder"))}).forEach(n=>{var u;const o={id:n.id,name:n.name,type:"file",extension:n.name.split(".").pop()},x=n.folderPath.split("/").filter(Boolean).pop();x&&t[x]?(u=t[x].children)==null||u.push(o):r.push(o)}),r};return e.jsxs("div",{className:"flex gap-4 h-[calc(100vh-250px)] min-h-[500px]",children:[e.jsx("input",{type:"file",className:"hidden",ref:_,onChange:ps}),e.jsxs("div",{className:"w-72 shrink-0 glass-card rounded-lg overflow-hidden border border-white/5 flex flex-col",children:[S&&e.jsx("div",{className:"p-2 border-b border-white/5 bg-primary/5 text-center",children:e.jsx(h,{variant:"ghost",size:"sm",className:"w-full text-xs",onClick:()=>z(null),children:"Limpar Seleção"})}),e.jsx(Ls,{onFileSelect:s=>z(s),onNewFile:$e,onNewFolder:js,onRefresh:B,onAction:vs,onMove:qe,files:ks(v)})]}),e.jsxs("div",{className:"flex-1 space-y-4 overflow-auto",children:[(re||pe>0)&&e.jsxs("div",{className:"flex items-center justify-between p-3 glass-card bg-emerald-500/10 rounded-lg border-emerald-500/20 animate-pulse",children:[e.jsxs("span",{className:"text-sm font-bold uppercase text-emerald-400 flex items-center gap-2",children:[e.jsx(De,{className:"size-4 animate-bounce"}),"Baixando: ",Q||"Preparando..."]}),e.jsxs(Ee,{variant:"outline",className:"text-emerald-400 border-emerald-400/30",children:["Fila: ",pe]})]}),g.length>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 glass-card bg-primary/5 rounded-lg border-primary/20",children:[e.jsxs("span",{className:"text-sm font-bold uppercase",children:[g.length," Itens Selecionados"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{size:"sm",variant:"ghost",className:"text-red-400 hover:text-red-300 hover:bg-red-500/10",onClick:()=>Z(!0),children:[e.jsx(ce,{className:"size-4 mr-2"})," Excluir Seleção"]}),e.jsxs(h,{size:"sm",variant:"ghost",onClick:gs,children:[e.jsx(De,{className:"size-4 mr-2"})," Baixar"]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>w([]),children:"Cancelar"})]})]}),e.jsxs("div",{className:"flex gap-4 justify-between",children:[e.jsx(q,{placeholder:"Buscar arquivos de sistema...",value:H,onChange:s=>Ae(s.target.value),className:"max-w-md industrial-input"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",size:"icon",onClick:()=>U(!0),title:"Organizar Arquivos Soltos",children:e.jsx(as,{className:"size-4"})}),e.jsx(h,{variant:"outline",size:"icon",onClick:()=>N(!0),title:"Gerar Estrutura Padrão",children:e.jsx(Be,{className:"size-4"})}),e.jsxs(h,{variant:"outline",onClick:fs,children:[e.jsx(De,{className:"size-4 mr-2"})," Baixar Tudo"]}),e.jsxs(h,{className:"gradient-primary",onClick:$e,children:[e.jsx(qs,{className:"size-4 mr-2"})," Upload SU"]})]})]}),e.jsxs(is,{className:"glass-card",children:[e.jsxs(ns,{children:[e.jsx(Os,{className:"text-sm uppercase tracking-widest font-black",children:"Documentação por Nível Hierárquico"}),e.jsx(ls,{children:"Manuais, Políticas e Arquivos de Configuração do Sistema."})]}),e.jsx(os,{className:"p-0",children:e.jsxs(cs,{children:[e.jsx(ds,{children:e.jsxs(K,{children:[e.jsx(G,{className:"w-10 pl-6",children:e.jsx(X,{checked:g.length===ee.length&&ee.length>0,onCheckedChange:s=>{w(s?ee.map(r=>r.id):[])}})}),e.jsx(G,{className:"uppercase text-[10px] font-bold",children:"Arquivo"}),e.jsx(G,{className:"uppercase text-[10px] font-bold",children:"Tipo"}),e.jsx(G,{className:"uppercase text-[10px] font-bold",children:"Data"}),e.jsx(G,{className:"text-right pr-6 uppercase text-[10px] font-bold",children:"Ações"})]})}),e.jsx(ms,{children:p?e.jsx(K,{children:e.jsx(M,{colSpan:4,className:"text-center py-10",children:"Carregando..."})}):ee.length===0?e.jsx(K,{children:e.jsx(M,{colSpan:4,className:"text-center py-10 italic opacity-50",children:"Pasta vazia"})}):ee.map(s=>e.jsxs(K,{onClick:r=>Cs(r,s.id),className:`cursor-pointer ${g.includes(s.id)?"bg-primary/10":"hover:bg-white/5"}`,children:[e.jsx(M,{className:"pl-6",children:e.jsx(X,{checked:g.includes(s.id),onCheckedChange:()=>{w(r=>r.includes(s.id)?r.filter(t=>t!==s.id):[...r,s.id])},onClick:r=>r.stopPropagation()})}),e.jsx(M,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ts,{className:"size-4 text-primary"}),e.jsx("span",{className:"font-bold text-sm",children:s.name})]})}),e.jsx(M,{children:e.jsx(Ee,{variant:"outline",className:"text-[10px]",children:s.docType})}),e.jsx(M,{className:"text-xs",children:s.updatedAt?(()=>{try{const r=new Date(s.updatedAt);return isNaN(r.getTime())?"-":Ye(r,"dd/MM/yyyy")}catch{return"-"}})():"-"}),e.jsx(M,{className:"text-right pr-6",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(h,{size:"icon",variant:"ghost",className:"size-8",onClick:()=>se(s),title:"Visualizar",children:e.jsx(Bs,{className:"size-4"})}),e.jsx(h,{size:"icon",variant:"ghost",className:"size-8",onClick:()=>y(s),title:"Download",children:e.jsx(De,{className:"size-4"})}),e.jsx(h,{size:"icon",variant:"ghost",className:"size-8",onClick:()=>$(s.id,s.fileUrl),title:"Excluir",children:e.jsx(ce,{className:"size-4"})})]})})]},s.id))})]})})]})]}),C&&e.jsx(Us,{open:D,onOpenChange:V,document:C,onSave:ys}),e.jsx(de,{open:Fe,onOpenChange:W,children:e.jsxs(me,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(he,{children:[e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(Hs,{className:"w-5 h-5 text-primary"})," Renomear Item"]}),e.jsx(Te,{className:"text-xs",children:"Digite o novo nome para o arquivo ou pasta."})]}),e.jsx("div",{className:"py-4 space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-[10px] uppercase font-black tracking-widest opacity-60",children:"Novo Nome"}),e.jsx(q,{value:le,onChange:s=>oe(s.target.value),className:"industrial-input",autoFocus:!0,onKeyDown:s=>s.key==="Enter"&&Ue()})]})}),e.jsxs(ue,{children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>W(!1),children:"Cancelar"}),e.jsx(h,{size:"sm",className:"gradient-primary",onClick:Ue,children:"Salvar Alteração"})]})]})}),e.jsx(de,{open:E,onOpenChange:T,children:e.jsxs(me,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(he,{children:[e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(Vs,{className:"w-5 h-5 text-primary"})," Criar Nova Pasta"]}),e.jsx(Te,{className:"text-xs",children:"Crie uma nova pasta para organizar seus documentos."})]}),e.jsx("div",{className:"py-4 space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{className:"text-[10px] uppercase font-black tracking-widest opacity-60",children:"Nome da Pasta"}),e.jsx(q,{value:ne,onChange:s=>fe(s.target.value),className:"industrial-input",placeholder:"Ex: Relatórios Técnicos",autoFocus:!0,onKeyDown:s=>s.key==="Enter"&&Le()})]})}),e.jsxs(ue,{children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>T(!1),children:"Cancelar"}),e.jsx(h,{size:"sm",className:"gradient-primary",onClick:Le,children:"Criar Pasta"})]})]})}),e.jsx(de,{open:!!k,onOpenChange:s=>!s&&Y(null),children:e.jsxs(me,{className:"glass-card border-white/10 sm:max-w-[450px]",children:[e.jsx(he,{children:e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"w-5 h-5 text-blue-400"})," ",k==null?void 0:k.title]})}),e.jsx("div",{className:"py-4 bg-white/2 rounded-lg p-4 border border-white/5",children:e.jsx("pre",{className:"text-xs font-mono text-white/70 whitespace-pre-wrap leading-relaxed",children:k==null?void 0:k.body})}),e.jsx(ue,{children:e.jsx(h,{size:"sm",variant:"outline",className:"border-white/10",onClick:()=>Y(null),children:"Fechar"})})]})}),e.jsx(ve,{open:a,onOpenChange:i,children:e.jsxs(ye,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(be,{children:[e.jsxs(we,{className:"flex items-center gap-2 text-red-500",children:[e.jsx(ce,{className:"w-5 h-5"})," Confirmar Exclusão"]}),e.jsxs(Ce,{className:"text-xs leading-relaxed",children:["Tem certeza que deseja excluir permanentemente"," ",e.jsxs("strong",{children:['"',l==null?void 0:l.name,'"']}),"? esta ação não pode ser desfeita."]})]}),e.jsxs(ke,{children:[e.jsx(Se,{className:"border-white/10 h-9",children:"Cancelar"}),e.jsx(ze,{className:"bg-red-500 hover:bg-red-600 h-9",onClick:()=>l&&bs(l.id,l.storagePath),children:"Excluir Agora"})]})]})}),e.jsx(ve,{open:j,onOpenChange:N,children:e.jsxs(ye,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(be,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-5 h-5 text-amber-400"})," Estrutura Base"]}),e.jsx(Ce,{className:"text-xs leading-relaxed",children:"Deseja criar a estrutura de pastas padrão (**Empresa, Obra, Canteiro**)? Arquivos não serão excluídos."})]}),e.jsxs(ke,{children:[e.jsx(Se,{className:"border-white/10 h-9",children:"Cancelar"}),e.jsx(ze,{className:"gradient-primary h-9",onClick:xs,children:"Confirmar Criação"})]})]})}),e.jsx(ve,{open:L,onOpenChange:U,children:e.jsxs(ye,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(be,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(as,{className:"w-5 h-5 text-emerald-400"})," Organizar Raiz"]}),e.jsx(Ce,{className:"text-xs leading-relaxed",children:"Deseja organizar automaticamente os arquivos soltos nas pastas apropriadas com base no contexto?"})]}),e.jsxs(ke,{children:[e.jsx(Se,{className:"border-white/10 h-9",children:"Cancelar"}),e.jsx(ze,{className:"gradient-primary h-9",onClick:us,children:"Organizar Agora"})]})]})}),e.jsx(ve,{open:O,onOpenChange:Z,children:e.jsxs(ye,{className:"glass-card border-white/10 sm:max-w-[400px]",children:[e.jsxs(be,{children:[e.jsxs(we,{className:"flex items-center gap-2 text-red-500",children:[e.jsx(ce,{className:"w-5 h-5"})," Confirmar Exclusão em Massa"]}),e.jsxs(Ce,{className:"text-xs leading-relaxed",children:["Você selecionou ",e.jsx("strong",{children:g.length})," itens. Tem certeza que deseja excluí-los permanentemente? Esta ação não pode ser desfeita."]})]}),e.jsxs(ke,{children:[e.jsx(Se,{className:"border-white/10 h-9",children:"Cancelar"}),e.jsxs(ze,{className:"bg-red-500 hover:bg-red-600 h-9",onClick:ws,children:["Excluir ",g.length," Itens"]})]})]})})]})}function va(){const{profile:v}=Ds(),{toast:p}=Es(),[P,J]=d.useState([]),[y,se]=d.useState([]),[b,$]=d.useState({}),[B,ae]=d.useState(!0),[re,Q]=d.useState(!1),[pe,H]=d.useState(!1),[Ae,S]=d.useState(!1),[z,g]=d.useState([]),[w,te]=d.useState(!1),[F,_]=d.useState({name:"",rank:0}),[D,V]=d.useState({code:"",name:"",category:"Geral"}),C=P.find(a=>a.name===((v==null?void 0:v.role)||"").toUpperCase()),ie=(C==null?void 0:C.rank)||0,E=Ts.value;d.useEffect(()=>{T()},[]);const T=async()=>{var a;ae(!0);try{const[i,l,m]=await Promise.all([A.from("permission_levels").select("*").order("rank",{ascending:!1}),A.from("permission_modules").select("*").order("category",{ascending:!0}),A.from("permission_matrix").select("*")]);i.data&&J(i.data),l.data&&se(l.data);const j={};(a=m.data)==null||a.forEach(N=>{j[`${N.level_id}:${N.module_id}`]=N.is_granted||!1}),$(j)}catch(i){console.error("Error fetching SU data:",i)}finally{ae(!1)}},ne=(a,i)=>{const l=`${a}:${i}`;$(m=>({...m,[l]:!m[l]}))},fe=(a,i)=>{const l={...b};P.forEach(m=>{m.rank<1e3&&(l[`${m.id}:${a}`]=i)}),$(l)},Me=(a,i)=>{const l={...b};y.forEach(m=>{l[`${a}:${m.id}`]=i}),$(l)},Pe=async()=>{Q(!0);try{const a=y.map(m=>m.code),i=Re.filter(m=>!a.includes(m.code));if(i.length===0){p({title:"Tudo em dia!",description:"Todos os módulos do sistema já estão na matriz."});return}const{error:l}=await A.from("permission_modules").insert(i);if(l)throw l;p({title:"Sincronização concluída",description:`${i.length} novos módulos foram adicionados à matriz.`}),T()}catch(a){p({title:"Erro na sincronização",description:a.message,variant:"destructive"})}finally{Q(!1)}},Fe=async()=>{var a,i;if(!re){console.log("[CustomSU] Iniciando salvamento da matriz..."),Q(!0);try{const l=Object.entries(b).map(([L,U])=>{const[O,Z]=L.split(":");return{level_id:O,module_id:Z,is_granted:U}}),m=await A.from("permission_matrix").upsert(l);if(m.error)throw m.error;const j=Array.isArray(m.data)?m.data[0]:m.data,N=j==null?void 0:j.taskId;if(N){p({title:"Processando...",description:"Aguarde a conclusão do salvamento em segundo plano."});let L=!1,U=0;for(;!L&&U<60;){await new Promise(O=>setTimeout(O,2e3)),U++;try{const O=A.baseUrl||"",k=await(await fetch(`${O}/task_queue/${N}`,{headers:{Authorization:`Bearer ${A.token}`}})).json(),Y=((a=k.data)==null?void 0:a.status)||k.status;if(Y==="completed")L=!0,p({title:"Matriz atualizada",description:"Todas as permissões foram salvas com sucesso!"});else if(Y==="failed")throw L=!0,new Error(((i=k.data)==null?void 0:i.error)||"Falha no processamento da tarefa")}catch(O){console.error("Polling error:",O)}}L||p({title:"Aviso",description:"O processamento está demorando mais que o esperado, mas continuará rodando."})}else p({title:"Matriz atualizada",description:"Todas as permissões foram salvas com sucesso."})}catch(l){p({title:"Erro ao salvar",description:l.message,variant:"destructive"})}finally{Q(!1)}}},W=async()=>{try{const{error:a}=await A.from("permission_levels").insert([F]);if(a)throw a;p({title:"Nível adicionado",description:`${F.name} agora faz parte da hierarquia.`}),H(!1),T()}catch(a){p({title:"Erro",description:a.message,variant:"destructive"})}},le=async()=>{try{const{error:a}=await A.from("permission_modules").insert([D]);if(a)throw a;p({title:"Módulo adicionado",description:`${D.name} disponível para configuração.`}),S(!1),T()}catch(a){p({title:"Erro",description:a.message,variant:"destructive"})}},oe=async a=>{if(confirm(`Deseja realmente excluir ${a.length} módulo(s)? Esta ação é irreversível.`)){te(!0);try{const{error:i}=await A.from("permission_modules").delete().in("id",a);if(i)throw i;p({title:"Módulos removidos",description:"Os itens foram excluídos com sucesso."}),g([]),T()}catch(i){p({title:"Erro ao excluir",description:i.message,variant:"destructive"})}finally{te(!1)}}},ge=a=>{g(i=>i.includes(a)?i.filter(l=>l!==a):[...i,a])},je=a=>{g(a?y.map(i=>i.id):[])};return B?e.jsx("div",{className:"flex h-[60vh] items-center justify-center",children:e.jsx(Oe,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6 animate-in fade-in duration-500",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-3",children:[e.jsx(As,{className:"w-8 h-8 text-primary"}),"Custom SU ",e.jsx(Ee,{variant:"secondary",className:"ml-2",children:"Matriz de Abas"})]}),e.jsx("p",{className:"text-muted-foreground mt-1 text-sm",children:"Mapeamento de permissões por Abas do Site e Níveis Hierárquicos."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[E&&e.jsxs(e.Fragment,{children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:Pe,children:[e.jsx(Ms,{className:"w-4 h-4 mr-2"})," Sincronizar Módulos"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>H(!0),children:[e.jsx(es,{className:"w-4 h-4 mr-2"})," Nível"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>S(!0),children:[e.jsx(es,{className:"w-4 h-4 mr-2"})," Módulo"]})]}),z.length>0&&E&&e.jsxs(h,{variant:"destructive",size:"sm",onClick:()=>oe(z),disabled:w,children:[w?e.jsx(Oe,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(He,{className:"w-4 h-4 mr-2"}),"Excluir (",z.length,")"]}),e.jsxs(h,{className:"gradient-primary",size:"sm",onClick:Fe,disabled:re,children:[re?e.jsx(Oe,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(ss,{className:"w-4 h-4 mr-2"}),"Salvar Matriz"]})]})]}),e.jsxs(Is,{defaultValue:"matrix",className:"w-full",children:[e.jsxs(Rs,{className:"glass-card mb-6 p-1 border-white/5",children:[e.jsxs(We,{value:"matrix",className:"gap-2 px-8",children:[e.jsx(ss,{className:"w-4 h-4"})," Matriz de Permissões"]}),e.jsxs(We,{value:"documents",className:"gap-2 px-8",children:[e.jsx(ts,{className:"w-4 h-4"})," Repositório por Nível"]})]}),e.jsx(Ze,{value:"matrix",className:"space-y-6",children:e.jsxs(is,{className:"glass-card overflow-hidden",children:[e.jsx(ns,{className:"bg-primary/5 border-b py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ls,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"w-4 h-4"})," Matriz: Abas do Site (Col 1) x Níveis (Col 2+)"]}),e.jsx(ce,{className:"w-4 h-4 text-muted-foreground/50"})]})}),e.jsx(os,{className:"p-0 overflow-x-auto",children:e.jsxs(cs,{children:[e.jsx(ds,{className:"bg-muted/30",children:e.jsxs(K,{children:[e.jsx(G,{className:"w-[350px] border-r-2 border-primary/20 sticky left-0 z-20 bg-background/95 backdrop-blur-md shadow-[4px_0_10px_-5px_rgba(0,0,0,0.5)]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{checked:z.length===y.length&&y.length>0,onCheckedChange:a=>je(!!a),className:"border-primary/40",disabled:!E}),e.jsx("span",{className:"font-black text-xs uppercase tracking-tighter",children:"Aba / Funcionalidade"})]})}),P.map(a=>{const i=a.rank>=1e3,l=y.length>0&&y.every(m=>b[`${a.id}:${m.id}`]);return e.jsx(G,{className:"text-center min-w-[120px] border-r border-white/5",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 py-4",children:[e.jsx("div",{className:Ie("px-3 py-1 rounded-full border text-[10px] font-black tracking-wider uppercase transition-all duration-300",Ps(a.name)),children:a.name.replace("_"," ")}),e.jsxs("span",{className:"text-[9px] text-primary/40 font-mono tracking-widest font-bold",children:["LVL ",a.rank]}),e.jsx("div",{className:"flex flex-col items-center gap-1 w-full pt-2 border-t border-primary/10",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{checked:i||l,onCheckedChange:m=>Me(a.id,!!m),disabled:i||a.rank>=ie&&!E,className:"w-3.5 h-3.5 border-primary/30 data-[state=checked]:bg-primary"}),e.jsx("span",{className:"text-[9px] font-black text-muted-foreground/60 uppercase",children:"Acesso"})]})})]})},a.id)})]})}),e.jsx(ms,{children:Array.from(new Set(y.map(a=>a.category))).map(a=>e.jsxs(rs.Fragment,{children:[e.jsx(K,{className:"bg-primary/10 hover:bg-primary/15 border-y-2 border-primary/20",children:e.jsx(M,{colSpan:P.length+1,className:"py-2.5 px-6 font-black text-primary text-xs uppercase tracking-[0.2em] shadow-inner",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-primary animate-pulse"}),a]})})}),y.filter(i=>i.category===a).map(i=>e.jsxs(K,{className:"hover:bg-white/2 transition-colors border-b border-white/5",children:[e.jsx(M,{className:"border-r-2 border-primary/20 p-0 sticky left-0 z-10 bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center justify-between gap-3 group/row px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{checked:z.includes(i.id),onCheckedChange:()=>ge(i.id),className:"w-4 h-4 border-primary/30",disabled:!E}),e.jsx(X,{checked:P.every(l=>l.rank>=1e3||b[`${l.id}:${i.id}`]),onCheckedChange:l=>fe(i.id,!!l),className:"w-4 h-4 border-primary/30 data-[state=checked]:bg-primary",disabled:!E&&P.some(l=>l.rank>=ie)}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-bold text-sm text-foreground/90 leading-none mb-1",children:i.name}),e.jsx("code",{className:"text-[9px] text-muted-foreground/60 font-mono tracking-tight uppercase",children:i.code})]})]}),E&&e.jsx(h,{variant:"ghost",size:"icon",className:"h-7 w-7 opacity-0 group-hover/row:opacity-100 text-destructive hover:bg-destructive/10 transition-all scale-90 hover:scale-100",onClick:()=>oe([i.id]),children:e.jsx(He,{className:"w-4 h-4"})})]})}),P.map(l=>{const m=b[`${l.id}:${i.id}`]||!1,j=l.rank>=1e3,N=l.rank>=ie&&!E;return e.jsx(M,{className:"text-center border-r border-white/5 p-0",children:e.jsx("div",{className:Ie("flex items-center justify-center px-2 py-4 h-full transition-colors",(m||j)&&"bg-primary/5",(j||N)&&"bg-primary/10"),children:e.jsx(X,{checked:j||m,disabled:j||N,className:Ie("w-5 h-5 transition-transform duration-200 hover:scale-110",(j||N)&&"bg-primary border-primary opacity-100 ring-2 ring-primary/20"),onCheckedChange:()=>ne(l.id,i.id)})})},l.id)})]},i.id))]},a))})]})})]})}),e.jsx(Ze,{value:"documents",children:e.jsx(Gs,{})})]}),e.jsx(de,{open:pe,onOpenChange:H,children:e.jsxs(me,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Novo Nível Hierárquico"}),e.jsx(Te,{children:"Escolha um nível padrão ou crie um personalizado."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{children:"Sugestões do Sistema"}),e.jsxs(Ve,{onValueChange:a=>{const i=Je.find(l=>l.name===a);i&&_({name:i.name,rank:i.rank})},children:[e.jsx(Xe,{className:"industrial-input",children:e.jsx(Ge,{placeholder:"Escolher um cargo padrão..."})}),e.jsx(Ke,{children:Je.map(a=>e.jsx(Qe,{value:a.name,children:e.jsxs("div",{className:"flex items-center justify-between w-full gap-4",children:[e.jsx("span",{children:Fs(a.name)}),e.jsxs(Ee,{variant:"outline",className:"text-[9px] opacity-50",children:["Rank ",a.rank]})]})},a.name))})]})]}),e.jsxs("div",{className:"relative py-2 rotate-0",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t border-white/10"})}),e.jsx("div",{className:"relative flex justify-center text-[10px] uppercase font-bold",children:e.jsx("span",{className:"bg-background px-2 text-muted-foreground",children:"Ou Manual"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{htmlFor:"level-name",children:"Nome do Nível"}),e.jsx(q,{id:"level-name",placeholder:"EX: GERENTE_REGIONAL",value:F.name,onChange:a=>_({...F,name:a.target.value.toUpperCase()})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{htmlFor:"level-rank",children:"Rank (Poder)"}),e.jsx(q,{id:"level-rank",type:"number",placeholder:"EX: 850",value:F.rank,onChange:a=>_({...F,rank:parseInt(a.target.value)})})]})]}),e.jsxs(ue,{children:[e.jsx(h,{variant:"ghost",onClick:()=>H(!1),children:"Cancelar"}),e.jsx(h,{className:"gradient-primary",onClick:W,children:"Criar Nível"})]})]})}),e.jsx(de,{open:Ae,onOpenChange:S,children:e.jsxs(me,{className:"max-w-md",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Nova Aba / Módulo"}),e.jsx(Te,{children:"Selecione uma funcionalidade padrão ou adicione manualmente."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{children:"Funcionalidades Disponíveis"}),e.jsxs(Ve,{onValueChange:a=>{const i=Re.find(l=>l.code===a);i&&V({code:i.code,name:i.name,category:i.category})},children:[e.jsx(Xe,{className:"industrial-input",children:e.jsx(Ge,{placeholder:"Escolher funcionalidade..."})}),e.jsx(Ke,{children:Re.filter(a=>!y.some(i=>i.code===a.code)).map(a=>e.jsx(Qe,{value:a.code,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a.name}),e.jsxs("span",{className:"text-[10px] opacity-60",children:["CAT: ",a.category]})]})},a.code))})]})]}),e.jsxs("div",{className:"relative py-2 rotate-0",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t border-white/10"})}),e.jsx("div",{className:"relative flex justify-center text-[10px] uppercase font-bold",children:e.jsx("span",{className:"bg-background px-2 text-muted-foreground",children:"Ou Manual"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{htmlFor:"module-name",children:"Nome Amigável"}),e.jsx(q,{id:"module-name",placeholder:"EX: Excluir Foto de Ponto",value:D.name,onChange:a=>V({...D,name:a.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{htmlFor:"module-code",children:"Código (ID Técnico)"}),e.jsx(q,{id:"module-code",placeholder:"EX: clock.delete_photo",value:D.code,onChange:a=>V({...D,code:a.target.value.toLowerCase()})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(R,{htmlFor:"module-category",children:"Categoria"}),e.jsx(q,{id:"module-category",placeholder:"EX: Ponto Eletrônico",value:D.category,onChange:a=>V({...D,category:a.target.value})})]})]}),e.jsxs(ue,{children:[e.jsx(h,{variant:"ghost",onClick:()=>S(!1),children:"Cancelar"}),e.jsx(h,{className:"gradient-primary",onClick:le,children:"Criar Módulo"})]})]})})]})}export{va as default};
