import{f as Ze,aA as _,j as e,D as ia,k as oa,l as la,m as na,aZ as Ha,o as ca,q as Se,p as ue,aS as da,B as f,r as c,S as ma,G as xa,a_ as Qe,H as pa,I as ha,J as Ve,bE as Ba,bF as Ka,L as we,aJ as ua,a7 as ga,t as de,$ as Qa,a4 as Wa,s as A,a$ as D,al as ba,am as fa,an as ja,ao as ke,b9 as va,u as Ja,ac as Za,a as Xa,w as Ya,ae as es,M as as,a0 as ss,aw as ts,bG as ea,bH as aa}from"./index-D951x4H-.js";import{u as $e,a as rs}from"./CartesianGrid-HrqNXgEf.js";import{T as is,a as os,b as Na,c as Y,d as ls,e as ee}from"./table-UwE0Vej1.js";import{C as ya,a as ns}from"./card-BTHGlYFz.js";import{I as We}from"./input-dNnkIPn6.js";import{A as cs,T as ds,E as ms}from"./ExcelImportModal-CNRE8bkL.js";import{T as wa}from"./textarea-Db2vMs5u.js";import{C as sa}from"./calendar-B3GVMfO3.js";import{T as ka}from"./triangle-alert-BPKdZxxI.js";import{f as ta}from"./format-CP1OFCPJ.js";import{T as Sa,a as Ia,b as Ce,c as Be}from"./tabs-D3Kawp4S.js";import{P as ye}from"./ProjectEmptyState-CRpC4Dgy.js";import{G as xs}from"./GAPOAnalyticsPanel-Db7gsqJw.js";import{C as Ge}from"./checkbox-B9hZgst_.js";import{A as De,h as Ue,a as Me,b as Pe,c as Oe,d as ze,e as _e,f as Le,g as Re}from"./alert-dialog-qR-bbYaw.js";import{L as ra}from"./list-BniZwJ04.js";import{C as ps}from"./circle-alert-BlgUQYiE.js";import{F as hs,P as Xe}from"./pen-C5GdyZXe.js";import{T as ge}from"./trash-2-DD2QlM38.js";import{S as us}from"./save-BcLL5Pf6.js";import{I as Ea}from"./info-MbzHf59N.js";import{u as Aa}from"./useWorkStages-DXnml1Pf.js";import{P as gs}from"./progress-CJuBekOD.js";import{A as Je}from"./activity-BYx2dwgt.js";import{P as Te}from"./plus-DmkF01H_.js";import{G as bs}from"./grip-vertical-BZqWG49f.js";import{E as fs}from"./ellipsis-vertical-DHbXCy2I.js";import{u as js}from"./useCompanies-kjFTA6Qu.js";import{u as vs}from"./useSites-Dum3dnEP.js";import{u as Ns}from"./useTimeRecords-RqrN7uRd.js";import{A as ys}from"./arrow-left-CQFd9_U_.js";import{L as ws}from"./layout-grid-4na9_LkO.js";import{S as ks}from"./search-BoEw84GM.js";import{U as Ss}from"./upload-D2Q7C-3S.js";import{A as xe,a as pe}from"./arrow-up-BfG5I1o5.js";import"./AreaChart-D9h5uedO.js";import"./calendar-MfduwZdl.js";import"./subDays-HHYU8WMe.js";import"./isSameDay-BB6-IGfB.js";import"./command-DzEVDCzR.js";import"./chevrons-up-down-BNQt7ayD.js";import"./xlsx-BBWTpfDg.js";import"./download-L1tB_Hhn.js";import"./Line-DWxI2lOG.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]],he=Ze("ArrowUpDown",Is);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=[["path",{d:"M10 18H5a3 3 0 0 1-3-3v-1",key:"ru65g8"}],["path",{d:"M14 2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2",key:"e30een"}],["path",{d:"M20 2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2",key:"2ahx8o"}],["path",{d:"m7 21 3-3-3-3",key:"127cv2"}],["rect",{x:"14",y:"14",width:"8",height:"8",rx:"2",key:"1b0bso"}],["rect",{x:"2",y:"2",width:"8",height:"8",rx:"2",key:"1x09vl"}]],As=Ze("Combine",Es);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cs=[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]],Ts=Ze("PenLine",Cs);function Ds({isOpen:o,onClose:w,towerName:m,activityName:M,statusData:x,onSaveNotes:C}){const[L,j]=_.useState((x==null?void 0:x.notes)||""),[R,U]=_.useState(!1);_.useEffect(()=>{j((x==null?void 0:x.notes)||"")},[x]);const y=async()=>{if(C){U(!0);try{await C(L),w()}finally{U(!1)}}};return x?e.jsx(ia,{open:o,onOpenChange:w,children:e.jsxs(oa,{className:"sm:max-w-[500px] bg-slate-950 border-slate-800 text-slate-100",children:[e.jsxs(la,{children:[e.jsxs(na,{className:"flex items-center gap-2 text-amber-500",children:[e.jsx(Ha,{className:"w-5 h-5"}),"Detalhes de Execução"]}),e.jsxs(ca,{className:"text-slate-400",children:[m," - ",e.jsx("span",{className:"text-sky-400 font-bold",children:M})]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/50 rounded-lg border border-slate-800",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] uppercase text-slate-500 font-bold",children:"Status Atual"}),e.jsx(Se,{variant:x.status==="FINISHED"?"default":"secondary",className:x.status==="FINISHED"?"bg-emerald-500/20 text-emerald-400 mt-1":"bg-sky-500/20 text-sky-400 mt-1",children:x.status==="FINISHED"?"CONCLUÍDO":x.status==="IN_PROGRESS"?"EM ANDAMENTO":"PENDENTE"})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("span",{className:"text-[10px] uppercase text-slate-500 font-bold",children:"Avanço"}),e.jsxs("span",{className:"text-xl font-bold font-mono text-white",children:[x.progressPercent||0,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ue,{className:"text-[10px] uppercase text-slate-500 font-bold",children:"Início Real"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm font-mono bg-black/20 p-2 rounded border border-white/5",children:[e.jsx(sa,{className:"w-4 h-4 text-emerald-500"}),x.startDate?ta(new Date(x.startDate),"dd/MM/yyyy"):"-"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ue,{className:"text-[10px] uppercase text-slate-500 font-bold",children:"Fim Real"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm font-mono bg-black/20 p-2 rounded border border-white/5",children:[e.jsx(sa,{className:"w-4 h-4 text-rose-500"}),x.endDate?ta(new Date(x.endDate),"dd/MM/yyyy"):"-"]})]})]}),x.impedimentType&&x.impedimentType!=="NONE"&&e.jsxs("div",{className:"bg-rose-950/20 border border-rose-900/50 p-3 rounded-lg flex items-start gap-3",children:[e.jsx(ka,{className:"w-5 h-5 text-rose-500 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-rose-400 uppercase",children:"Impedimento / Atraso"}),e.jsxs("p",{className:"text-xs text-rose-300/80 mt-1",children:["Tipo: ",x.impedimentType]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"text-xs font-semibold text-slate-400",children:"Comentários / Observações"}),e.jsx(wa,{value:L,onChange:T=>j(T.target.value),placeholder:"Adicione informações sobre atrasos, planejamento ou execução...",className:"bg-slate-900 border-slate-800 focus:border-amber-500/50 min-h-[100px] text-sm"})]})]}),e.jsxs(da,{className:"flex justify-between sm:justify-between",children:[e.jsxs("div",{className:"text-[10px] text-slate-600 self-center",children:["ID: ",x.progressId||"N/A"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{variant:"ghost",onClick:w,size:"sm",children:"Fechar"}),e.jsx(f,{onClick:y,disabled:R,size:"sm",className:"bg-amber-600 hover:bg-amber-700",children:R?"Salvando...":"Salvar Notas"})]})]})]})}):null}const Ke=[{id:"cat-pre",name:"SERVIÇOS PRELIMINARES",order:1,activities:[{id:"act-croqui",name:"Croqui de Acesso",weight:1,order:1},{id:"act-sonda",name:"Sondagem",weight:1,order:2},{id:"act-conf",name:"Conferência de Perfil",weight:1,order:3},{id:"act-veg",name:"Supressão Vegetal (Área)",weight:1,order:4},{id:"act-acesso",name:"Abertura de Acessos",weight:1,order:5}]},{id:"cat-fund",name:"FUNDAÇÕES",order:2,activities:[{id:"act-esc",name:"Escavação (Mastro/Pé)",weight:1,order:1},{id:"act-arm",name:"Armação (Mastro/Pé)",weight:1,order:2},{id:"act-conc",name:"Concretagem (Mastro/Pé)",weight:1,order:3},{id:"act-niv",name:"Nivelamento / Preparação",weight:.5,order:4},{id:"act-reat",name:"Reaterro",weight:.5,order:5}]},{id:"cat-mont",name:"MONTAGEM",order:3,activities:[{id:"act-pre-mont",name:"Pré-Montagem",weight:1,order:1},{id:"act-icamento",name:"Içamento",weight:1,order:2},{id:"act-rev",name:"Revisão / Torque",weight:.5,order:3}]},{id:"cat-cabos",name:"LANÇAMENTO DE CABOS",order:4,activities:[{id:"act-lanc-guia",name:"Lançamento Cabo Guia",weight:1,order:1},{id:"act-lanc-cond",name:"Lançamento Condutor",weight:2,order:2},{id:"act-gramp",name:"Grampeação",weight:1,order:3},{id:"act-reg",name:"Regulação",weight:1,order:4}]}];function Ca({isOpen:o,onClose:w,stage:m,onSave:M,onDelete:x,onSync:C,onRefresh:L}){const[j,R]=c.useState("manual"),[U,y]=c.useState(""),[T,d]=c.useState(""),[H,I]=c.useState("1.0"),[z,F]=c.useState("none"),[S,q]=c.useState(!1),[P,V]=c.useState(""),[k,Q]=c.useState(new Set),[v,W]=c.useState(new Set),[$,ie]=c.useState(new Set),s=!!m,{data:O,isLoading:be}=$e({queryKey:["production-categories"],queryFn:async()=>{try{const a=(await de.get("/production/categories")).data;return!a||a.length===0?Ke:a}catch(r){return console.warn("Falha ao carregar categorias do backend, usando padrão local.",r),Ke}},enabled:o&&j==="import",initialData:Ke});c.useEffect(()=>{m?(y(m.name),d(m.description||""),I(String(m.weight)),F(m.productionActivityId||"none"),R("manual")):(y(""),d(""),I("1.0"),F("none"),Q(new Set),W(new Set)),V("")},[m,o]);const fe=async r=>{if(r.preventDefault(),V(""),!U.trim()){V("O nome da etapa é obrigatório.");return}const a=parseFloat(H.replace(",","."));if(isNaN(a)||a<=0||a>1){V("O peso deve ser um número entre 0.01 e 1.0");return}q(!0);try{(await M({name:U.trim(),description:T.trim()||void 0,weight:a,productionActivityId:z!=="none"?z:null})).success&&w()}finally{q(!1)}},oe=async()=>{const r=k.size>0,a=v.size>0;if(console.log("[Import] Iniciando importação...",{hasActivities:r,hasActivitiesCount:k.size,hasCategoriesOnly:a}),!r&&!a){V("Selecione pelo menos uma categoria ou atividade para importar.");return}q(!0),V("");try{for(const l of O||[]){const b=l.activities.filter(u=>k.has(u.id));if(!(v.has(l.id)||b.length>0))continue;console.log(`[Import] Criando Meta Mãe: ${l.name} (Ordem: ${l.order})`);const n=await M({name:l.name,description:b.length>0?`Etapa principal com ${b.length} sub-metas`:"Meta principal",weight:1,displayOrder:l.order},!0),g=n.stageId;console.log(`[Import] Meta Mãe criada. ID: ${g}`,n),g||console.warn(`[Import] Alerta: Meta Mãe "${l.name}" criada mas ID não retornado. Sub-metas ficarão órfãs.`),await new Promise(u=>setTimeout(u,200));for(const u of b)console.log(`[Import] Criando Sub-meta: ${u.name} (Parent: ${g}, Ordem: ${u.order})`),await M({name:u.name,description:`Sub-meta de ${l.name}`,weight:Number(u.weight)||1,parentId:g,displayOrder:u.order,productionActivityId:u.id},!0),await new Promise(J=>setTimeout(J,300))}console.log("[Import] Processo concluído com sucesso."),C?(console.log("[Importação] Iniciando sincronização de dados..."),await C()):L==null||L(),w()}catch(l){console.error("[Import] Erro fatal durante a importação:",l),V(l.message||"Erro ao importar etapas")}finally{q(!1)}},Ie=async()=>{if(!(!m||!x)){q(!0);try{(await x(m.id)).success&&w()}finally{q(!1)}}},le=(r,a)=>{const l=new Set(k);if(l.has(r))l.delete(r);else{l.add(r);const b=new Set(v);b.delete(a),W(b)}Q(l)},je=r=>{const a=O==null?void 0:O.find(u=>u.id===r);if(!a)return;const l=a.activities.filter(u=>k.has(u.id)).length,b=v.has(r),h=l>0||b,n=new Set(k),g=new Set(v);h?(a.activities.forEach(u=>n.delete(u.id)),g.delete(r)):(a.activities.forEach(u=>n.add(u.id)),g.add(r)),Q(n),W(g)},ae=r=>{const a=new Set($);a.has(r)?a.delete(r):a.add(r),ie(a)},ve=()=>{Q(new Set),W(new Set)},B=()=>{const r=new Set;return O==null||O.forEach(a=>{(a.activities.some(l=>k.has(l.id))||v.has(a.id))&&r.add(a.id)}),r.size+k.size};return e.jsx(ia,{open:o,onOpenChange:w,children:e.jsxs(oa,{className:"max-w-2xl max-h-[85vh] overflow-hidden flex flex-col bg-slate-950 border-slate-800 text-slate-100",children:[e.jsxs(la,{children:[e.jsx(na,{className:"text-xl font-bold text-amber-500",children:s?"Editar Etapa":"Nova Etapa de Obra"}),e.jsx(ca,{className:"text-slate-400",children:s?"Atualize os dados da etapa.":"Adicione uma nova etapa ou importe das atividades de produção."})]}),!s&&e.jsx(Sa,{value:j,onValueChange:r=>R(r),className:"w-full",children:e.jsxs(Ia,{className:"grid w-full grid-cols-2 bg-slate-900",children:[e.jsxs(Ce,{value:"manual",className:"data-[state=active]:bg-amber-500/20 data-[state=active]:text-amber-500",children:[e.jsx(Ts,{className:"h-4 w-4 mr-2"}),"Manual"]}),e.jsxs(Ce,{value:"import",className:"data-[state=active]:bg-amber-500/20 data-[state=active]:text-amber-500",children:[e.jsx(ra,{className:"h-4 w-4 mr-2"}),"Importar Atividades"]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto py-4",children:[P&&e.jsxs("div",{className:"bg-rose-950/30 border border-rose-500/30 text-rose-400 p-3 rounded-lg text-sm flex items-center gap-2 mb-4",children:[e.jsx(ps,{className:"h-4 w-4"}),P]}),(j==="manual"||s)&&e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{htmlFor:"name",className:"text-xs uppercase font-bold tracking-wider text-slate-400",children:"Nome da Etapa *"}),e.jsx(We,{id:"name",value:U,onChange:r=>y(r.target.value),placeholder:"Ex: Fundação, Montagem, Lançamento...",className:"bg-black/40 border-slate-700",autoFocus:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{htmlFor:"description",className:"text-xs uppercase font-bold tracking-wider text-slate-400",children:"Descrição"}),e.jsx(wa,{id:"description",value:T,onChange:r=>d(r.target.value),placeholder:"Descrição detalhada da etapa (opcional)",className:"bg-black/40 border-slate-700 min-h-[80px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{htmlFor:"weight",className:"text-xs uppercase font-bold tracking-wider text-slate-400",children:"Peso na Obra (0.01 a 1.0)"}),e.jsx(We,{id:"weight",type:"text",inputMode:"decimal",value:H,onChange:r=>I(r.target.value),placeholder:"Ex: 0.25 (25% do peso total)",className:"bg-black/40 border-slate-700 w-32"}),e.jsx("p",{className:"text-[10px] text-slate-500",children:"O peso define a importância relativa desta etapa no cálculo do avanço físico geral."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{htmlFor:"activityLink",className:"text-xs uppercase font-bold tracking-wider text-slate-400",children:"Vincular à Atividade de Produção"}),e.jsxs(ma,{value:z,onValueChange:F,children:[e.jsx(xa,{className:"bg-black/40 border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[z!=="none"&&e.jsx(Qe,{className:"h-3 w-3 text-amber-500 fill-amber-500/20"}),e.jsx(pa,{placeholder:"Selecione uma atividade para vincular automático"})]})}),e.jsxs(ha,{className:"max-h-[300px]",children:[e.jsx(Ve,{value:"none",children:"-- Sem Vínculo Automático --"}),O==null?void 0:O.map(r=>e.jsxs(Ba,{children:[e.jsx(Ka,{className:"text-amber-500 font-bold px-2 py-1.5 text-xs uppercase tracking-wider bg-slate-900/50",children:r.name}),r.activities.map(a=>e.jsx(Ve,{value:a.id,className:"pl-6 text-sm",children:a.name},a.id))]},r.id))]})]}),e.jsx("p",{className:"text-[10px] text-emerald-500/80",children:"Ao vincular, o avanço desta etapa será atualizado automaticamente quando a produção for apontada."})]})]}),j==="import"&&!s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-400",children:"Selecione as categorias e atividades:"}),e.jsxs("p",{className:"text-[10px] text-slate-500",children:[e.jsx(hs,{className:"h-3 w-3 inline mr-1"}),"Marque só a categoria = Meta Mãe | Marque atividades = Meta Mãe + Sub-metas"]})]}),e.jsx(f,{variant:"ghost",size:"sm",onClick:ve,className:"text-xs",children:"Limpar"})]}),be?e.jsx("div",{className:"flex items-center justify-center py-10",children:e.jsx(we,{className:"h-6 w-6 animate-spin text-amber-500"})}):e.jsx("div",{className:"space-y-2 max-h-[350px] overflow-y-auto pr-2",children:O==null?void 0:O.map(r=>{const a=r.activities.filter(n=>k.has(n.id)).length,l=v.has(r.id),b=$.has(r.id),h=a>0||l;return e.jsxs("div",{className:`bg-slate-900/50 rounded-lg border transition-all ${h?"border-amber-500/50 bg-amber-500/5":"border-slate-800"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 p-3",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6 p-0",onClick:()=>ae(r.id),children:b?e.jsx(ua,{className:"h-4 w-4 text-slate-500"}):e.jsx(ga,{className:"h-4 w-4 text-slate-500"})}),e.jsx("div",{className:"flex items-center gap-2 cursor-pointer",onClick:()=>je(r.id),children:e.jsx(Ge,{checked:h,className:"border-amber-500 data-[state=checked]:bg-amber-500"})}),e.jsx("span",{className:"font-bold text-sm text-amber-500 uppercase tracking-wider flex-1 cursor-pointer",onClick:()=>ae(r.id),children:r.name}),l&&e.jsx(Se,{className:"bg-amber-500/20 text-amber-400 text-[9px]",children:"Só Meta Mãe"}),a>0&&e.jsxs(Se,{className:"bg-emerald-500/20 text-emerald-400 text-[9px]",children:[a," sub-metas"]}),e.jsx(f,{variant:"ghost",size:"sm",className:"text-[10px] h-6 px-2",onClick:()=>je(r.id),children:h?"Limpar":"Todas"})]}),b&&e.jsx("div",{className:"px-3 pb-3 pt-0 border-t border-slate-800/50",children:e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-2",children:r.activities.map(n=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-sm text-slate-300 hover:text-white p-1.5 rounded hover:bg-slate-800/50",children:[e.jsx(Ge,{checked:k.has(n.id),onCheckedChange:()=>le(n.id,r.id)}),e.jsx("span",{className:"truncate",children:n.name})]},n.id))})})]},r.id)})}),B()>0&&e.jsxs("p",{className:"text-xs text-amber-500 font-medium",children:[B()," item(s) selecionado(s) para importar"]})]})]}),e.jsxs(da,{className:"flex items-center justify-between border-t border-slate-800 pt-4",children:[s&&x?e.jsxs(De,{children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(f,{variant:"ghost",className:"text-rose-500 hover:bg-rose-950/30 hover:text-rose-400",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Excluir"]})}),e.jsxs(Me,{className:"bg-slate-950 border-slate-800",children:[e.jsxs(Pe,{children:[e.jsx(Oe,{className:"text-rose-500",children:"Excluir Etapa"}),e.jsxs(ze,{children:['Tem certeza que deseja excluir a etapa "',m==null?void 0:m.name,'"? Esta ação não pode ser desfeita.']})]}),e.jsxs(_e,{children:[e.jsx(Le,{className:"border-slate-700",children:"Cancelar"}),e.jsx(Re,{onClick:Ie,className:"bg-rose-600 hover:bg-rose-700",children:"Sim, Excluir"})]})]})]}):e.jsx("div",{}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{variant:"outline",onClick:w,className:"border-slate-700 hover:bg-slate-800",children:"Cancelar"}),j==="manual"||s?e.jsxs(f,{onClick:fe,disabled:S,className:"bg-amber-600 hover:bg-amber-700 text-white font-bold",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),S?"Salvando...":s?"Salvar Alterações":"Criar Etapa"]}):e.jsxs(f,{onClick:oe,disabled:S||B()===0,className:"bg-amber-600 hover:bg-amber-700 text-white font-bold",children:[e.jsx(ra,{className:"h-4 w-4 mr-2"}),S?"Importando...":`Importar ${B()} Item(s)`]})]})]})]})})}const Ms=({stage:o,onUpdate:w})=>{var I;const[m,M]=c.useState(!1),[x,C]=c.useState(!1),{data:L}=$e({queryKey:["production-categories"],queryFn:async()=>(await de.get("/production/categories")).data||[],staleTime:1e3*60*60}),j=o.productionActivityId,R=!!j&&j!=="none",y=R&&((I=o.metadata)==null?void 0:I.mapEnabled)!==!1,T=async()=>{x||(y?M(!0):await d())},d=async()=>{C(!0);try{if(R)await w(o.id,{metadata:{...o.metadata,mapEnabled:!0}}),D.success("Visualização no Mapa ativada");else{let z="";if(L)for(const F of L){const S=F.activities.find(q=>q.name.trim().toLowerCase()===o.name.trim().toLowerCase());if(S){z=S.id;break}}z?(await w(o.id,{productionActivityId:z,metadata:{...o.metadata,mapEnabled:!0}}),D.success("Atividade vinculada e visualização ativada")):D.error(`Não foi encontrada uma atividade de produção correspondente para "${o.name}". Verifique o nome.`)}}catch{D.error("Erro ao ativar visualização")}finally{C(!1)}},H=async()=>{M(!1),C(!0);try{await w(o.id,{metadata:{...o.metadata,mapEnabled:!1}}),D.info("Visualização no Mapa desativada (Dados mantidos)")}catch{D.error("Erro ao desativar visualização")}finally{C(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full flex items-center justify-between gap-2 px-1",children:[e.jsx("span",{className:"truncate max-w-[90px] text-[10px] font-medium",title:o.name,children:o.name}),e.jsx(f,{variant:"ghost",size:"icon",className:A("h-6 w-6 rounded-full border transition-all",y?"bg-green-500/20 text-green-500 border-green-500/50 hover:bg-green-500/30":"bg-red-500/20 text-red-500 border-red-500/50 hover:bg-red-500/30"),onClick:T,disabled:x,title:y?"Ativo (Vinculado ao Mapa)":"Visualização Desativada (Dados Mantidos)",children:x?e.jsx(we,{className:"h-3 w-3 animate-spin"}):y?e.jsx(Qa,{className:"h-3 w-3"}):e.jsx(Wa,{className:"h-3 w-3"})})]}),e.jsx(De,{open:m,onOpenChange:M,children:e.jsxs(Me,{className:"bg-slate-950 border-slate-800 text-slate-100",children:[e.jsxs(Pe,{children:[e.jsxs(Oe,{className:"flex items-center gap-2 text-amber-500",children:[e.jsx(Ea,{className:"h-5 w-5"}),"Desativar Visualização 3D?"]}),e.jsxs(ze,{className:"text-slate-400",children:["Ao desativar esta opção, o avanço desta etapa ",e.jsx("strong",{children:"deixará de ser colorido no Mapa 3D"}),".",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{className:"text-green-400 font-bold",children:"Importante:"})," Os dados de execução na tabela ",e.jsx("strong",{children:"serão mantidos"})," e continuarão visíveis. Apenas a visualização no mapa será desligada.",e.jsx("br",{}),e.jsx("br",{}),"Deseja continuar?"]})]}),e.jsxs(_e,{children:[e.jsx(Le,{className:"bg-slate-800 border-slate-700 hover:bg-slate-700 text-slate-100",children:"Cancelar"}),e.jsx(Re,{onClick:H,className:"bg-red-900 border-red-800 hover:bg-red-800 text-red-100",children:"Sim, Desativar Visual"})]})]})})]})};function Ps({siteId:o,projectId:w}){const{stages:m,isLoading:M,createStage:x,updateStage:C,deleteStage:L,deleteAllStages:j,reorderStages:R,syncStages:U,refresh:y}=Aa(o||"all",w),[T,d]=c.useState(!1),[H,I]=c.useState(null),[z,F]=c.useState(null),[S,q]=c.useState(new Set),[P,V]=c.useState(null),[k,Q]=c.useState(null),[v,W]=c.useState(!1),$=c.useMemo(()=>{const a=new Map,l=[];m.forEach(n=>{a.set(n.id,{...n,children:[],progress:{...n.progress}})}),m.forEach(n=>{const g=a.get(n.id);n.parentId&&a.has(n.parentId)?a.get(n.parentId).children.push(g):l.push(g)});const b=n=>{var se;if(n.children.length===0)return((se=n.progress)==null?void 0:se.actualPercentage)||0;let g=0,u=0;n.children.forEach(G=>{const E=b(G),X=Number(G.weight)||0;g+=X,u+=E*X});const J=g>0?u/g:0;return n.progress={...n.progress||{},actualPercentage:J},J},h=n=>{n.sort((g,u)=>g.displayOrder-u.displayOrder),n.forEach(g=>{h(g.children)})};return h(l),l.forEach(n=>b(n)),l},[m]),ie=(a,l)=>a>=l?"text-emerald-500":a<l*.8?"text-red-500":"text-amber-500",s=(a=null)=>{I(null),F(a),d(!0)},O=a=>{I(a),F(null),d(!0)},be=async(a,l=!1)=>H?C(H.id,a):x({...a,parentId:a.parentId||z||void 0},l),fe=async()=>{W(!0);try{await U()}finally{W(!1)}},oe=async a=>L(a),Ie=async()=>j(),le=a=>{const l=new Set(S);l.has(a)?l.delete(a):l.add(a),q(l)},je=(a,l)=>{V(l),a.dataTransfer.effectAllowed="move",a.stopPropagation()},ae=(a,l)=>{a.preventDefault(),a.stopPropagation(),Q(l)},ve=async(a,l)=>{if(a.preventDefault(),a.stopPropagation(),!P||P===l){V(null),Q(null);return}const b=m.find(E=>E.id===P),h=m.find(E=>E.id===l);if(!b||!h)return;if(b.parentId!==h.parentId){V(null),Q(null);return}const n=m.filter(E=>E.parentId===b.parentId).sort((E,X)=>E.displayOrder-X.displayOrder),g=n.findIndex(E=>E.id===P),u=n.findIndex(E=>E.id===l);if(g===-1||u===-1)return;const J=[...n],[se]=J.splice(g,1);J.splice(u,0,se);const G=J.map((E,X)=>({...E,displayOrder:X}));V(null),Q(null),await R(G)},B=()=>{V(null),Q(null)},r=(a,l,b=0)=>{var g,u,J,se;const h=a.children.length>0,n=S.has(a.id);return e.jsxs("div",{className:b>0?"ml-8 border-l-2 border-slate-800 pl-4":"",children:[e.jsx(ya,{draggable:!0,onDragStart:G=>je(G,a.id),onDragOver:G=>ae(G,a.id),onDrop:G=>ve(G,a.id),onDragEnd:B,className:`glass-card overflow-hidden group transition-all mb-2 cursor-grab active:cursor-grabbing ${P===a.id?"opacity-50 scale-[0.98]":""} ${k===a.id?"border-amber-500 bg-amber-500/5":"hover:border-primary/20"} ${b>0?"bg-slate-900/30":""}`,children:e.jsx(ns,{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-slate-600 hover:text-slate-400 cursor-grab active:cursor-grabbing",children:e.jsx(bs,{className:"h-4 w-4"})}),h?e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6 p-0",onClick:()=>le(a.id),children:n?e.jsx(ua,{className:"h-4 w-4 text-amber-500"}):e.jsx(ga,{className:"h-4 w-4 text-slate-500"})}):e.jsx("div",{className:"w-6"}),e.jsx("div",{className:`w-7 h-7 rounded-full flex items-center justify-center font-bold text-xs ${b===0?"bg-amber-500/20 text-amber-500":"bg-slate-700/50 text-slate-400"}`,children:b===0?l+1:"↳"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:`font-bold truncate ${b>0?"text-sm":"text-base"}`,children:a.name}),a.productionActivityId&&e.jsx(Qe,{className:"h-3.5 w-3.5 text-amber-500 fill-amber-500/20"}),e.jsxs(Se,{variant:"outline",className:"text-[10px] font-black tracking-widest bg-white/5 uppercase",children:["Peso: ",(a.weight*100).toFixed(0),"%"]}),h&&e.jsxs(Se,{variant:"outline",className:"text-[10px] bg-sky-500/10 text-sky-500 border-sky-500/30 flex gap-1 items-center",children:[e.jsx(As,{className:"h-2.5 w-2.5"}),"Consolidado (",a.children.length,")"]})]})}),e.jsxs("div",{className:"w-32 space-y-1.5",children:[e.jsxs("div",{className:"flex justify-between text-xs font-bold",children:[e.jsx("span",{className:"text-slate-500",children:"Progresso"}),e.jsxs("span",{className:ie(((g=a.progress)==null?void 0:g.actualPercentage)||0,((u=a.progress)==null?void 0:u.plannedPercentage)||0),children:[Math.min(100,((J=a.progress)==null?void 0:J.actualPercentage)||0).toFixed(2),"%"]})]}),e.jsx(gs,{value:Math.min(100,((se=a.progress)==null?void 0:se.actualPercentage)||0),className:"h-1.5 bg-white/5"})]}),e.jsxs(ba,{children:[e.jsx(fa,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(fs,{className:"h-4 w-4"})})}),e.jsxs(ja,{align:"end",className:"bg-slate-950 border-slate-800",children:[e.jsxs(ke,{onClick:()=>s(a.id),className:"cursor-pointer",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"Adicionar Sub-etapa"]}),e.jsx(va,{className:"bg-slate-800"}),e.jsxs(ke,{onClick:()=>O(a),className:"cursor-pointer",children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Editar"]}),e.jsxs(ke,{onClick:()=>oe(a.id),className:"cursor-pointer text-rose-500 focus:text-rose-500",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Excluir"]})]})]})]})})}),h&&n&&e.jsx("div",{className:"space-y-0",children:a.children.map((G,E)=>r(G,E,b+1))})]},a.id)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(Je,{className:"w-5 h-5 text-primary"}),"Acompanhamento de Metas"]}),e.jsxs("p",{className:"text-xs text-muted-foreground italic font-medium",children:["Cronograma Físico x Realizado por etapa de obra.",m.length>0&&e.jsx("span",{className:"text-amber-500 ml-1",children:"Arraste para reordenar • Clique ⋮ para sub-etapas"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[m.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:fe,disabled:v,className:"border-amber-500/30 text-amber-500 hover:bg-amber-500/10 gap-2 font-bold",children:[v?e.jsx(we,{className:"w-3 h-3 animate-spin"}):e.jsx(Qe,{className:"w-3 h-3"}),"Sincronizar Produção"]}),e.jsxs(De,{children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(f,{variant:"outline",size:"sm",className:"border-rose-500/30 text-rose-500 hover:bg-rose-950/20 gap-2",children:[e.jsx(ge,{className:"w-3 h-3"})," Remover Todas"]})}),e.jsxs(Me,{className:"bg-slate-950 border-slate-800",children:[e.jsxs(Pe,{children:[e.jsxs(Oe,{className:"text-rose-500 flex items-center gap-2",children:[e.jsx(ka,{className:"h-5 w-5"}),"Remover Todas as Etapas"]}),e.jsxs(ze,{children:["Tem certeza que deseja remover ",e.jsxs("strong",{children:["todas as ",m.length," etapas"]}),"? Esta ação não pode ser desfeita."]})]}),e.jsxs(_e,{children:[e.jsx(Le,{className:"border-slate-700",children:"Cancelar"}),e.jsx(Re,{onClick:Ie,className:"bg-rose-600 hover:bg-rose-700",children:"Sim, Remover Todas"})]})]})]})]}),e.jsxs(f,{onClick:()=>s(null),className:"gradient-primary font-bold gap-2",children:[e.jsx(Te,{className:"w-4 h-4"})," Nova Etapa"]})]})]}),e.jsx("div",{className:"space-y-0",children:M?e.jsxs("div",{className:"py-20 text-center glass-card italic text-muted-foreground",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),"Calculando avanço físico..."]}):$.length===0?e.jsxs("div",{className:"py-20 text-center glass-card",children:[e.jsx("p",{className:"italic text-muted-foreground mb-4",children:"Nenhuma etapa de obra cadastrada para este projeto."}),e.jsxs(f,{onClick:()=>s(null),variant:"outline",className:"border-amber-500/30 text-amber-500 hover:bg-amber-500/10",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"})," Adicionar Primeira Etapa"]})]}):$.map((a,l)=>r(a,l,0))}),e.jsx(Ca,{isOpen:T,onClose:()=>{d(!1),F(null)},stage:H,onSave:be,onDelete:oe,onSync:U,onRefresh:y})]})}const Ta=_.memo(({tower:o,idx:w,categories:m,onDelete:M,onEdit:x,onSelectCell:C,isPending:L,isSelected:j,onToggleSelect:R,onContextMenuCell:U})=>e.jsxs(Na,{className:A("group/row transition-colors border-b border-amber-900/10",w%2===0?"bg-white/1.5":"bg-transparent",j&&"bg-primary/10 hover:bg-primary/15"),children:[e.jsx(ee,{className:"sticky left-0 w-[40px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-center p-2 transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:e.jsx(Ge,{checked:j,onCheckedChange:y=>R(o.id,y),className:"border-white/20 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"})}),e.jsx(ee,{className:"sticky left-[40px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-center p-2 transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"h-7 w-7 text-amber-600/30 hover:text-primary hover:bg-primary/10 transition-colors rounded-md",onClick:()=>x(o),children:e.jsx(Xe,{className:"h-3 w-3"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-7 w-7 text-destructive/20 hover:text-destructive hover:bg-destructive/10 transition-colors rounded-md",onClick:()=>M(o.id,o.objectId),disabled:L,children:e.jsx(ge,{className:"h-3 w-3"})})]})}),e.jsx(ee,{className:"font-black sticky left-[120px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-center text-primary text-xs transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:e.jsx("span",{className:"font-mono tracking-tighter text-shadow-glow",children:o.objectId})}),e.jsx(ee,{className:"sticky left-[220px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-[10px] font-bold text-center text-amber-100/40 tracking-wider font-mono transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:o.trecho||"-"}),e.jsx(ee,{className:"sticky left-[300px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-center transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:e.jsx(Se,{variant:"outline",className:"px-2 py-0.5 text-[8px] font-black uppercase tracking-widest border-amber-900/30 text-amber-600/50",children:o.towerType||"N/A"})}),e.jsx(ee,{className:"sticky left-[400px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-[10px] text-center font-bold text-amber-100/20 italic transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:o.goForward||"-"}),e.jsx(ee,{className:"sticky left-[500px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-[10px] text-center font-bold text-amber-100/20 italic transition-colors shadow-[1px_0_3px_rgba(0,0,0,0.2)] opacity-100",children:o.totalConcreto||"-"}),e.jsx(ee,{className:"sticky left-[600px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-[10px] text-center font-bold text-amber-100/20 italic transition-colors shadow-[2px_0_5px_rgba(0,0,0,0.3)] opacity-100",children:o.pesoArmacao||"-"}),e.jsx(ee,{className:"sticky left-[700px] bg-[#0a0806] group-hover/row:bg-[#1a1612] z-30 border-r border-amber-900/20 text-[10px] text-center font-bold text-primary italic transition-colors shadow-[4px_0_15px_rgba(0,0,0,0.7)] opacity-100",children:o.pesoEstrutura||"-"}),m==null?void 0:m.map(y=>e.jsx(_.Fragment,{children:y.activities.map(T=>{var z,F;const d=o.activityStatuses.find(S=>S.activityId===T.id),H=(z=o.activitySchedules)==null?void 0:z.find(S=>S.activityId===T.id);let I=!1;if(H&&H.plannedEnd){const S=new Date(H.plannedEnd),q=new Date;d&&d.status==="FINISHED"&&d.endDate?new Date(d.endDate)>S&&(I=!0):q>S&&(I=!0)}return e.jsx(ee,{className:"p-1 text-center border-r border-amber-900/10 cursor-pointer hover:bg-primary/20 group-hover/row:bg-primary/5 transition-all duration-300",onClick:()=>C({towerId:o.id,towerName:o.objectId,towerType:o.towerType,activityId:T.id,activityName:T.name,status:d}),onContextMenu:S=>U(S,{towerId:o.id,towerName:o.objectId,towerType:o.towerType,activityId:T.id,activityName:T.name,status:d}),children:d?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-1.5 py-1.5 relative min-h-[52px]",children:[d.requiresApproval&&e.jsx("div",{className:"badge-verificar animate-verificar",children:"VERIFICAR"}),I&&e.jsx("div",{className:"absolute top-0 right-0 w-2 h-2 rounded-full bg-red-600 shadow-[0_0_5px_rgba(220,38,38,0.8)] z-20",title:"Atividade Atrasada"}),e.jsx("div",{className:A("absolute bottom-0 left-0 h-0.5 transition-all duration-500 z-10",I?"bg-red-500/80":"bg-blue-500/80"),style:{width:`${d.progressPercent||0}%`}}),e.jsx("div",{className:A("w-full px-1.5 py-0.5 rounded text-[11px] font-black uppercase tracking-tight z-10 shadow-sm",d.status==="FINISHED"?"status-concluido":d.status==="IN_PROGRESS"?"status-andamento":"status-pendente",I&&d.status!=="FINISHED"&&"border border-red-500/50 text-red-100"),children:d.status==="FINISHED"?"CONCLUÍDO":d.status==="IN_PROGRESS"?`AND. ${d.progressPercent}%`:"PENDENTE"}),d.landStatus&&d.landStatus!=="FREE"&&e.jsx("div",{className:A("w-full px-1 py-0.5 rounded-sm text-[10px] font-black uppercase tracking-tighter z-10 border",d.landStatus==="EMBARGO"?"bg-red-950/40 text-red-500 border-red-500/50":"bg-orange-950/40 text-orange-500 border-orange-500/50"),children:d.landStatus==="EMBARGO"?"EMBARGO":"IMPEDIMENTO"}),e.jsx("div",{className:"flex items-center gap-1.5 z-10 mt-0.5",children:((F=d.metadata)==null?void 0:F.leadName)&&d.metadata.leadName!=="none"&&e.jsx("span",{className:"text-[8px] font-bold text-amber-500/80 uppercase tracking-tighter",children:d.metadata.leadName.split(" ")[0]})})]}):e.jsxs("div",{className:"py-4 flex items-center justify-center opacity-10 relative",children:[I&&e.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-red-600 shadow-[0_0_5px_rgba(220,38,38,0.8)] z-20",title:"Não Iniciado - Atrasado"}),e.jsx("div",{className:"w-1 h-1 rounded-full bg-foreground"})]})},T.id)})},y.id))]},o.id));Ta.displayName="ProductionTableRow";const St=()=>{const{profile:o}=Ja(),w=Za(),m=Xa(),[M,x]=c.useState("grid"),[C,L]=c.useState(""),[j,R]=c.useState(null),[U,y]=c.useState(!1),[T,d]=c.useState(!1),[H,I]=c.useState(!1),[z,F]=c.useState(null),[S,q]=c.useState(!1),[P,V]=c.useState(null),[k,Q]=c.useState((o==null?void 0:o.companyId)||"all"),[v,W]=c.useState("all"),$=v,ie=k==="all"?void 0:k,[s,O]=c.useState({key:"objectSeq",direction:"asc"}),{companies:be,isLoading:fe}=js(),{projects:oe,isLoading:Ie}=Ya();c.useEffect(()=>{o!=null&&o.companyId&&k==="all"&&Q(o.companyId)},[o==null?void 0:o.companyId,k]),c.useEffect(()=>{if(k==="all"){v!=="all"&&W("all");return}if(oe.length===0)return;const t=oe.filter(p=>p.companyId===k);if(t.length===0){v!=="all"&&W("all");return}if(!t.some(p=>p.id===v)||v==="all"){const p=t.find(N=>N.id===(o==null?void 0:o.projectId));W(p?p.id:t[0].id)}},[k,oe,o==null?void 0:o.projectId,v]);const{sites:le,isLoading:je}=vs($!=="all"?$:void 0),[ae,ve]=c.useState("all");c.useEffect(()=>{v&&v!=="all"?ae!=="all"&&!le.find(t=>t.id===ae)&&ve("all"):ve("all")},[le,v,ae]);const B=ae,{data:r,isLoading:a}=$e({queryKey:["production-towers",$,ie,B],queryFn:async()=>{const t=new URLSearchParams;return $&&$!=="all"&&t.append("projectId",$),ie&&t.append("companyId",ie),B&&B!=="all"&&t.append("siteId",B),(await de.get(`/production/tower-status?${t.toString()}`)).data},enabled:!!ie||!!(o!=null&&o.companyId)}),{data:l=[],isLoading:b}=$e({queryKey:["production-categories"],queryFn:async()=>(await de.get("/production/categories")).data}),{stages:h,createStage:n,updateStage:g,isLoading:u}=Aa(B||"all",v),{records:J,isLoading:se}=Ns(),{users:G,isLoading:E}=es(),X=rs({mutationFn:async t=>{await de.delete(`/map_elements?id=${t}`)},onSuccess:()=>{w.invalidateQueries({queryKey:["production-towers"]}),D.success("Torre removida com sucesso")},onError:t=>{D.error("Erro ao remover torre: "+(t instanceof Error?t.message:"Erro desconhecido"))}}),[te,Ee]=c.useState([]),[Fe,ne]=c.useState(!1),Da=_.useCallback((t,i)=>{Ee(p=>i?[...p,t]:p.filter(N=>N!==t))},[]),Ma=t=>{Ee(t&&re?re.map(i=>i.id):[])},Pa=async()=>{if(te.length!==0){ne(!0);try{for(const t of te)await de.delete(`/map_elements?id=${t}`),await new Promise(i=>setTimeout(i,300));D.success(`${te.length} torres removidas com sucesso`),Ee([]),w.invalidateQueries({queryKey:["production-towers"]})}catch{D.error("Erro ao remover torres")}finally{ne(!1)}}},Oa=async()=>{if(!(!r||r.length===0)){ne(!0);try{for(const t of r)await de.delete(`/map_elements?id=${t.id}`),await new Promise(i=>setTimeout(i,150));D.success("Todas as torres foram removidas com sucesso"),Ee([]),w.invalidateQueries({queryKey:["production-towers"]})}catch{D.error("Erro ao remover todas as torres")}finally{ne(!1)}}},za=async()=>{if(!(!h||h.length===0)&&window.confirm("Isso irá desativar a visualização de TODAS as etapas no Mapa. Os dados serão mantidos. Deseja continuar?")){ne(!0);try{for(const t of h)await g(t.id,{metadata:{...t.metadata,mapEnabled:!1}}),await new Promise(i=>setTimeout(i,150));D.success("Visualização de todas as etapas desativada.")}catch{D.error("Erro ao desativar visualização.")}finally{ne(!1)}}},_a=async()=>{var t;if(!(!h||!l||h.length===0)){ne(!0);try{const i=l;let p=0;for(const N of h){let Z="";for(const K of i){const ce=K.activities.find(Ua=>Ua.name.trim().toLowerCase()===N.name.trim().toLowerCase());if(ce){Z=ce.id;break}}Z&&Z!=="none"&&(N.productionActivityId!==Z||((t=N.metadata)==null?void 0:t.mapEnabled)!==!0)&&(p++,await g(N.id,{productionActivityId:Z,metadata:{...N.metadata,mapEnabled:!0}}),await new Promise(ce=>setTimeout(ce,150)))}p>0?D.success(`${p} etapas vinculadas automaticamente.`):D.info("Nenhuma nova vinculação encontrada.")}catch{D.error("Erro ao realizar vínculo automático.")}finally{ne(!1)}}},Ae=_.useMemo(()=>{if(!h||h.length===0)return;console.log("[stageColumns] Transformando etapas:",h.length);const t=h.filter(p=>!p.parentId).sort((p,N)=>(Number(p.displayOrder)||0)-(Number(N.displayOrder)||0)),i=h.filter(p=>p.parentId);return t.map((p,N)=>{const Z=i.filter(K=>K.parentId===p.id).sort((K,ce)=>(Number(K.displayOrder)||0)-(Number(ce.displayOrder)||0)).map((K,ce)=>({id:K.productionActivityId||"custom-"+K.id,categoryId:p.id,name:K.name,description:null,weight:K.weight,order:ce,stageId:K.id,productionActivityId:K.productionActivityId,metadata:K.metadata}));return{id:p.id,name:p.name,description:p.description||null,order:N,activities:Z}}).filter(p=>p.activities.length>0)},[h]),me=t=>{let i="asc";s&&s.key===t&&s.direction==="asc"&&(i="desc"),O({key:t,direction:i})},He=_.useMemo(()=>{if(!r)return[];const t=[...r];return s!==null&&t.sort((i,p)=>{const N=i[s.key],Z=p[s.key];return N==null?1:Z==null?-1:N<Z?s.direction==="asc"?-1:1:N>Z?s.direction==="asc"?1:-1:0}),t},[r,s]),re=He==null?void 0:He.filter(t=>{var i;return t.objectId.toLowerCase().includes(C.toLowerCase())||((i=t.trecho)==null?void 0:i.toLowerCase().includes(C.toLowerCase()))}),[La,Ra]=c.useState(0),Ne=_.useRef(null),qe=_.useRef(null);_.useEffect(()=>{const t=()=>{if(Ne.current){const N=Ne.current.scrollWidth;Ra(N)}};t(),window.addEventListener("resize",t);const i=setTimeout(t,1e3),p=setInterval(t,3e3);return()=>{window.removeEventListener("resize",t),clearTimeout(i),clearInterval(p)}},[re,Ae]);const Ye=t=>{const i=t.target;i===Ne.current&&qe.current?qe.current.scrollLeft=i.scrollLeft:i===qe.current&&Ne.current&&(Ne.current.scrollLeft=i.scrollLeft)},Fa=_.useCallback((t,i)=>{window.confirm(`Deseja realmente excluir a torre ${i}?`)&&X.mutate(t)},[X]),qa=_.useCallback(t=>{F(t),y(!0)},[]),Va=_.useCallback(t=>{R(t)},[]),$a=_.useCallback((t,i)=>{t.preventDefault(),V(i),q(!0)},[]),Ga=async t=>{var N;if(!P)return;const i=P.status,p={elementId:P.towerId,activityId:P.activityId,status:(i==null?void 0:i.status)||"PENDING",landStatus:(i==null?void 0:i.landStatus)||"FREE",impedimentType:(i==null?void 0:i.impedimentType)||"NONE",foremanName:((N=i==null?void 0:i.metadata)==null?void 0:N.leadName)||null,progressPercent:(i==null?void 0:i.progressPercent)||0,startDate:i==null?void 0:i.startDate,endDate:i==null?void 0:i.endDate,notes:t,requiresApproval:!1,metadata:i==null?void 0:i.metadata};await de.post("/production/tower-status",p),D.success("Notas atualizadas com sucesso"),w.invalidateQueries({queryKey:["production-towers"]})};return a||b||fe||Ie||je||u||se||E?e.jsx("div",{className:"flex h-screen items-center justify-center bg-background",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(we,{className:"h-12 w-12 animate-spin text-primary"}),e.jsx("p",{className:"text-sm font-bold uppercase tracking-widest text-primary/60",children:"Sincronizando Dados..."})]})}):e.jsxs("div",{className:"h-screen w-full bg-background flex flex-col overflow-hidden font-sans",children:[e.jsxs("header",{className:"shrink-0 flex items-center justify-between px-6 py-4 border-b border-primary/20 bg-background/95 backdrop-blur-xl z-50 shadow-2xl relative",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>m("/"),className:"h-9 w-9 text-muted-foreground hover:text-foreground hover:bg-white/5 rounded-full mr-2",title:"Voltar ao Início",children:e.jsx(ys,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-black tracking-tighter bg-linear-to-r from-primary via-primary to-primary/40 bg-clip-text text-transparent uppercase italic drop-shadow-sm",children:"GESTÃO DE PRODUÇÃO"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1 w-8 bg-primary rounded-full shadow-[0_0_10px_rgba(var(--primary),0.6)]"}),e.jsx("p",{className:"text-muted-foreground text-[10px] font-bold uppercase tracking-[0.3em]",children:"Controle Técnico e Planejamento"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[(["SUPER_ADMIN","SUPER_ADMIN_GOD","ADMIN"].includes((o==null?void 0:o.role)||"")||be.length>1)&&e.jsx("div",{className:"w-[200px]",children:e.jsxs(ma,{value:k,onValueChange:Q,children:[e.jsx(xa,{className:"bg-slate-900/50 border-white/10 h-10 text-[11px] font-bold uppercase tracking-wider rounded-xl transition-all hover:bg-slate-800/50 hover:border-primary/30 focus:ring-primary/20",children:e.jsxs("div",{className:"flex items-center gap-2 truncate",children:[e.jsx(as,{className:"w-3.5 h-3.5 text-primary"}),e.jsx(pa,{placeholder:"Selecione a Empresa"})]})}),e.jsxs(ha,{className:"bg-slate-950 border-white/10 backdrop-blur-xl max-h-[300px]",children:[e.jsx(Ve,{value:"all",children:"TODAS AS EMPRESAS"}),be.map(t=>e.jsx(Ve,{value:t.id,className:"text-[11px] font-bold uppercase tracking-wider",children:t.name},t.id))]})]})}),e.jsx(ss,{value:v,onValueChange:W,className:"w-[200px]",companyId:k}),e.jsx("div",{className:"h-8 w-px bg-white/10 mx-1"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ya,{className:"glass-card bg-primary/5 hover:bg-primary/10 group relative overflow-hidden h-14 flex items-center px-5 gap-4 border-primary/20",children:[e.jsx("div",{className:"p-2.5 rounded-2xl bg-primary/10 group-hover:bg-primary/20 group-hover:scale-110 transition-all duration-500",children:e.jsx(ts,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx("span",{className:"text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 transition-colors",children:"Inventário Total"}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsx("span",{className:"text-2xl font-black tracking-tighter italic text-foreground text-shadow-glow",children:(r==null?void 0:r.length)||0}),e.jsx("span",{className:"text-[10px] font-bold text-muted-foreground/80 uppercase tracking-wider",children:"Torres"})]})]})]}),e.jsx("div",{className:"h-8 w-px bg-white/10 mx-2"}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-foreground hover:bg-white/5 rounded-full",children:e.jsx(Ea,{className:"h-5 w-5"})})]})]})]}),e.jsxs(Sa,{value:M,onValueChange:x,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"shrink-0 z-40 bg-background/95 backdrop-blur-xl border-b border-white/5 py-4 px-6 shadow-xl space-y-3",children:e.jsxs("div",{className:"flex flex-col xl:flex-row xl:items-center justify-between gap-4 mb-4",children:[e.jsxs(Ia,{className:"glass-card p-1 flex justify-start w-fit bg-secondary/20",children:[e.jsxs(Ce,{value:"grid",className:"gap-2 px-4 py-2 data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:[e.jsx(ws,{className:"w-4 h-4"})," Grelha de Produção"]}),e.jsxs(Ce,{value:"progress",className:"gap-2 px-4 py-2 data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:[e.jsx(Je,{className:"w-4 h-4"})," Avanço Físico"]}),e.jsxs(Ce,{value:"performance",className:"gap-2 px-4 py-2 data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:[e.jsx(ea,{className:"w-4 h-4"})," Performance (KPIs)"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-3 w-full xl:w-auto",children:[M==="grid"&&e.jsxs("div",{className:"relative w-full sm:w-80 group",children:[e.jsx(ks,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-primary/50 group-focus-within:text-primary transition-colors"}),e.jsx(We,{placeholder:"Localizar torre ou trecho...",className:"pl-9 bg-black/40 border-white/10 focus:border-primary/50 focus:ring-1 focus:ring-primary/20 h-9 text-xs transition-all rounded-lg text-foreground placeholder:text-muted-foreground/30 font-medium",value:C,onChange:t=>L(t.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[M==="grid"&&e.jsxs(e.Fragment,{children:[e.jsxs(ba,{children:[e.jsx(fa,{asChild:!0,children:e.jsxs(f,{variant:"outline",size:"sm",className:"gap-2 border-primary/20 hover:bg-primary/10 glass text-foreground font-bold h-9 px-4 rounded-lg flex-1 sm:flex-none uppercase text-[10px] tracking-wider",disabled:Fe,children:[e.jsx(Xe,{className:"h-3.5 w-3.5 text-primary"}),"Configurar"]})}),e.jsxs(ja,{align:"end",className:"w-56 bg-slate-950 border-slate-800",children:[e.jsx(aa,{children:"Gestão de Etapas"}),e.jsxs(ke,{onClick:()=>I(!0),className:"cursor-pointer",children:[e.jsx(Te,{className:"mr-2 h-4 w-4"})," Criar/Editar Etapas"]}),e.jsx(va,{className:"bg-slate-800"}),e.jsx(aa,{children:"Mapa Visual (Vínculos)"}),e.jsxs(ke,{onClick:_a,className:"cursor-pointer",children:[e.jsx(Je,{className:"mr-2 h-4 w-4 text-green-500"}),"Auto-Vincular Todas"]}),e.jsxs(ke,{onClick:za,className:"cursor-pointer text-red-500 focus:text-red-500",children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Desvincular Todas"]})]})]}),e.jsxs(f,{variant:"outline",size:"sm",className:"gap-2 border-primary/20 hover:bg-primary/10 glass text-foreground font-bold h-9 px-4 rounded-lg flex-1 sm:flex-none uppercase text-[10px] tracking-wider",onClick:()=>d(!0),children:[e.jsx(Ss,{className:"h-3.5 w-3.5 text-primary"}),"Importar"]}),te.length>0&&e.jsx("div",{className:"flex gap-2 animate-in fade-in slide-in-from-top-2",children:e.jsxs(De,{children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(f,{variant:"destructive",size:"sm",className:"gap-2 h-9 px-4 rounded-lg uppercase text-[10px] tracking-wider font-bold",disabled:Fe,children:[Fe?e.jsx(we,{className:"w-3 h-3 animate-spin"}):e.jsx(ge,{className:"w-3 h-3"}),"Excluir (",te.length,")"]})}),e.jsxs(Me,{children:[e.jsxs(Pe,{children:[e.jsx(Oe,{children:"Confirmar Exclusão"}),e.jsxs(ze,{children:["Tem certeza que deseja excluir ",e.jsx("b",{children:te.length})," torres selecionadas?"]})]}),e.jsxs(_e,{children:[e.jsx(Le,{children:"Cancelar"}),e.jsx(Re,{onClick:Pa,className:"bg-destructive hover:bg-destructive/90",children:"Excluir"})]})]})]})}),!te.length&&e.jsxs(De,{children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(f,{variant:"ghost",size:"sm",className:"gap-2 h-9 px-4 rounded-lg uppercase text-[10px] tracking-wider font-bold text-destructive hover:bg-destructive/10",disabled:Fe,children:[e.jsx(ge,{className:"w-3 h-3"}),"Excluir Tudo"]})}),e.jsxs(Me,{children:[e.jsxs(Pe,{children:[e.jsx(Oe,{className:"text-destructive",children:"PERIGO: Excluir TODO o Projeto?"}),e.jsxs(ze,{children:["Você está prestes a excluir ",e.jsx("b",{children:"TODAS AS TORRES"})," deste projeto.",e.jsx("br",{}),e.jsx("br",{}),"Quantidade: ",e.jsxs("b",{children:[(r==null?void 0:r.length)||0," torres"]}),".",e.jsx("br",{}),e.jsx("br",{}),"Esta ação não pode ser desfeita."]})]}),e.jsxs(_e,{children:[e.jsx(Le,{children:"Cancelar"}),e.jsx(Re,{onClick:Oa,className:"bg-destructive hover:bg-destructive/90",children:"Sim, Excluir TUDO"})]})]})]}),e.jsxs(f,{size:"sm",className:"gap-2 shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:scale-[1.02] active:scale-95 gradient-primary border-none text-primary-foreground font-black uppercase tracking-wider h-9 px-4 rounded-lg flex-1 sm:flex-none text-[10px]",onClick:()=>{F(null),y(!0)},children:[e.jsx(Te,{className:"h-4 w-4"}),"Nova Torre"]})]}),e.jsxs(f,{variant:"outline",size:"sm",className:"gap-2 border-sky-500/30 hover:bg-sky-500/10 text-sky-400 font-bold h-9 px-4 rounded-lg flex-1 sm:flex-none uppercase text-[10px] tracking-wider",onClick:()=>m("/producao/analytics"),children:[e.jsx(ea,{className:"h-3.5 w-3.5"}),"Analytics & Custos"]})]})]})]})}),e.jsxs("main",{className:"flex-1 flex flex-col overflow-hidden relative bg-black/20",children:[e.jsx(Be,{value:"grid",className:"h-full flex flex-col data-[state=active]:flex",children:a?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(we,{className:"w-12 h-12 animate-spin text-primary opacity-20"})}):!r||r.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center p-8 h-[60vh]",children:e.jsx(ye,{type:"towers",title:"Nenhuma Torre Cadastrada",description:"Esta obra ainda não possui torres ou atividades técnicas. Você pode importar uma planilha Excel ou cadastrar manualmente.",onAction:()=>y(!0),onSecondaryAction:()=>d(!0),actionLabel:"Nova Torre",secondaryActionLabel:"Importar Excel"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:qe,onScroll:Ye,className:"overflow-x-auto h-2 bg-background/80 border-b border-primary/20 shrink-0 scrollbar-thin scrollbar-thumb-primary/60 scrollbar-track-transparent z-50",children:e.jsx("div",{style:{width:La||"3000px"},className:"h-full"})}),e.jsx("div",{className:"flex-1 overflow-auto scrollbar-thin scrollbar-thumb-amber-600/40 scrollbar-track-amber-900/5 bg-[#0a0806] select-none",ref:Ne,onScroll:Ye,children:e.jsxs(is,{className:"border-separate border-spacing-0 w-full min-w-max",children:[e.jsx(os,{className:"sticky top-0 z-50 shadow-2xl",children:e.jsxs(Na,{className:"bg-[#0a0806] hover:bg-[#0a0806] border-b border-amber-900/30",children:[e.jsx(Y,{className:"w-[70px] h-14 sticky left-0 top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 text-center font-black uppercase text-[10px] tracking-widest text-foreground p-0",children:e.jsx("div",{className:"flex items-center justify-center w-full h-full",children:e.jsx(Ge,{checked:re&&re.length>0&&te.length===re.length,onCheckedChange:t=>Ma(t),className:"border-white/20 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground"})})}),e.jsx(Y,{className:"w-[80px] h-14 sticky left-[40px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 text-center font-black uppercase text-[10px] tracking-widest text-foreground",children:"MENU"}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[120px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="objectId"&&"text-primary"),onClick:()=>me("objectId"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"ID OBRA"}),(s==null?void 0:s.key)==="objectId"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="objectId"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[120px] h-14 sticky left-[220px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="trecho"&&"text-primary"),onClick:()=>me("trecho"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"SUBTRECHO"}),(s==null?void 0:s.key)==="trecho"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="trecho"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[340px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="towerType"&&"text-primary"),onClick:()=>me("towerType"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"ESTRUTURA"}),(s==null?void 0:s.key)==="towerType"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="towerType"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[440px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="goForward"&&"text-primary"),onClick:()=>me("goForward"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"VÃO (M)"}),(s==null?void 0:s.key)==="goForward"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="goForward"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[540px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="totalConcreto"&&"text-primary"),onClick:()=>me("totalConcreto"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"VOL (M³)"}),(s==null?void 0:s.key)==="totalConcreto"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="totalConcreto"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[640px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[2px_0_8px_rgba(0,0,0,0.5)] opacity-100",(s==null?void 0:s.key)==="pesoArmacao"&&"text-primary"),onClick:()=>me("pesoArmacao"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"AÇO (KG)"}),(s==null?void 0:s.key)==="pesoArmacao"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="pesoArmacao"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),e.jsxs(Y,{className:A("w-[100px] h-14 sticky left-[740px] top-0 bg-[#0a0806] z-50 border-r border-amber-900/20 cursor-pointer hover:bg-[#1a1612] transition-colors group text-center shadow-[4px_0_15px_rgba(0,0,0,0.7)] opacity-100",(s==null?void 0:s.key)==="pesoEstrutura"&&"text-primary"),onClick:()=>me("pesoEstrutura"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 h-full",children:[e.jsx("span",{className:"font-black uppercase text-[10px] tracking-widest group-hover:text-primary transition-colors",children:"TORRE (T)"}),(s==null?void 0:s.key)==="pesoEstrutura"?s.direction==="asc"?e.jsx(xe,{className:"h-3 w-3"}):e.jsx(pe,{className:"h-3 w-3"}):e.jsx(he,{className:"h-3 w-3 opacity-30 group-hover:opacity-100 transition-opacity"})]}),e.jsx("div",{className:A("absolute bottom-0 left-0 w-full h-0.5 bg-primary transition-transform origin-left",(s==null?void 0:s.key)==="pesoEstrutura"?"scale-x-100":"scale-x-0 group-hover:scale-x-100")})]}),Ae==null?void 0:Ae.map(t=>e.jsx(_.Fragment,{children:t.activities.map(i=>e.jsxs(Y,{className:"min-w-[160px] h-14 bg-[#0a0806] z-40 sticky top-0 text-center border-r border-amber-900/10 font-black text-[10px] uppercase tracking-widest text-[#d4af37]/80 group hover:bg-[#1a1612] transition-colors opacity-100 p-0",children:[e.jsxs("div",{className:"w-full h-full flex flex-col justify-center",children:[e.jsx("div",{className:"w-full text-center py-1 bg-[#1a1612]/50 border-b border-white/5",children:e.jsx("span",{className:"text-amber-600/40 text-[8px] font-bold tracking-[0.2em] leading-none",children:t.name.toUpperCase()})}),e.jsx(Ms,{stage:{id:i.stageId||i.id,name:i.name,siteId:B||"",parentId:t.id,description:null,weight:i.weight,displayOrder:0,createdAt:new Date,productionActivityId:i.productionActivityId,metadata:i.metadata},onUpdate:async(p,N)=>{await g(p,N)}})]}),e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-0.5 bg-primary scale-x-0 group-hover:scale-x-100 transition-transform origin-left"})]},i.id))},t.id))]})}),e.jsx(ls,{children:re==null?void 0:re.map((t,i)=>e.jsx(Ta,{tower:t,idx:i,categories:Ae,onDelete:Fa,onEdit:qa,onSelectCell:Va,isPending:X.isPending,isSelected:te.includes(t.id),onToggleSelect:Da,onContextMenuCell:$a},t.id))})]})})]})}),e.jsx(Be,{value:"progress",className:"h-full overflow-auto p-6",children:!r||r.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center h-[60vh]",children:e.jsx(ye,{type:"towers",title:"Sem Torres para Acompanhar",description:"Para visualizar o progresso físico, é necessário primeiro cadastrar as torres da obra.",onAction:()=>y(!0),actionLabel:"Nova Torre"})}):!le||le.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center h-[60vh]",children:e.jsx(ye,{type:"sites",title:"Nenhum Canteiro Encontrado",description:"Para acompanhar o avanço físico, você precisa primeiro cadastrar os canteiros e trechos desta obra.",onAction:()=>m("/canteiros"),actionLabel:"Configurar Canteiros"})}):!h||h.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center h-[60vh]",children:e.jsx(ye,{type:"generic",title:"Etapas Não Configuradas",description:"Não foram encontradas etapas de trabalho (Atividades) para este canteiro. Verifique as configurações de cronograma.",onAction:()=>I(!0),actionLabel:"Configurar Etapas"})}):e.jsx(Ps,{siteId:B,projectId:v})}),e.jsx(Be,{value:"performance",className:"h-full overflow-auto p-6",children:!r||r.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center h-[60vh]",children:e.jsx(ye,{type:"towers",title:"Sem Dados de Performance",description:"A análise de performance requer que existam torres e atividades cadastradas na obra.",onAction:()=>y(!0),actionLabel:"Nova Torre"})}):!G||G.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center h-[60vh]",children:e.jsx(ye,{type:"workers",title:"Nenhum Funcionário Alocado",description:"Não há dados de performance pois ainda não foram cadastrados funcionários ou equipes para esta obra.",onAction:()=>m("/usuarios"),actionLabel:"Cadastrar Equipe"})}):e.jsx(xs,{stages:h,records:J,projectId:v!=="all"?v:void 0})})]})]}),j&&e.jsx(cs,{isOpen:!!j,onClose:()=>R(null),elementId:j.towerId,towerName:j.towerName,towerType:j.towerType,activityId:j.activityId,activityName:j.activityName,currentStatus:j.status,projectId:$}),P&&e.jsx(Ds,{isOpen:S,onClose:()=>q(!1),towerName:P.towerName,activityName:P.activityName,statusData:P.status,onSaveNotes:Ga}),e.jsx(ds,{isOpen:U,onClose:()=>y(!1),projectId:$,tower:z}),e.jsx(ms,{isOpen:T,onClose:()=>d(!1),projectId:$}),e.jsx(Ca,{isOpen:H,onClose:()=>I(!1),onSave:n,onRefresh:()=>w.invalidateQueries({queryKey:["work-stages"]})})]})};export{St as default};
