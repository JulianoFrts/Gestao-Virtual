import{V as k,g as $,r as I,a2 as u,W as f,aL as v,aM as q}from"./index-D951x4H-.js";const s=k([]),A=k(!1);function B(){const{toast:w}=$(),[b,R]=I.useState(!0),i=async e=>{await u.setItem("timeRecords",e)},h=I.useCallback(async()=>{console.log("[useTimeRecords] loadRecords started"),A.value=!0,R(!0);try{console.log("[useTimeRecords] Fetching from storage...");const e=await u.getItem("timeRecords")||[],o=e.filter(r=>!r.syncedAt);if(console.log(`[useTimeRecords] Local cached found: ${e.length}, Unsynced: ${o.length}`),navigator.onLine){console.log("[useTimeRecords] Online: fetching from API...");const{data:r,error:n}=await f.from("time_records").select(`
            *,
            user:users!time_records_user_id_fkey(name)
          `).order("recorded_at",{ascending:!1}).limit(100);if(n)throw console.error("[useTimeRecords] API Error:",n),n;console.log(`[useTimeRecords] API Data received: ${(r==null?void 0:r.length)||0} items`);const c=(r||[]).map(t=>{var p;return{id:t.id,employeeId:t.user_id,userId:t.user_id,employeeName:(p=t.user)==null?void 0:p.name,teamId:t.team_id,companyId:t.company_id,recordType:t.record_type,type:t.record_type==="entry"?"IN":"OUT",photoUrl:t.photo_url,location:t.latitude?`${t.latitude},${t.longitude}`:"N/A",latitude:t.latitude,longitude:t.longitude,recordedAt:v(t.recorded_at)||new Date,createdBy:t.created_by,syncedAt:v(t.synced_at),localId:t.local_id}});console.log("[useTimeRecords] Mapping finished, merging results...");const d=new Set(c.map(t=>t.localId).filter(Boolean)),_=[...o.filter(t=>!t.localId||!d.has(t.localId)),...c];s.value=_,console.log("[useTimeRecords] Signal updated, saving to storage..."),await i(_),console.log("[useTimeRecords] Storage updated")}else console.log("[useTimeRecords] Offline: using cached records"),s.value=e}catch(e){console.error("[useTimeRecords] Error loading time records:",e);const o=await u.getItem("timeRecords")||[];s.value=o}finally{console.log("[useTimeRecords] Setting isLoadingRecords to false"),A.value=!1,R(!1)}},[]);I.useEffect(()=>{h()},[h]);const D=async e=>{var t,p,S,T;const o=q();let r=null;try{r=((p=(t=(await f.auth.getSession()).data.session)==null?void 0:t.user)==null?void 0:p.id)||null}catch{console.warn("Network auth check failed, using local fallback")}if(!r)for(let l=0;l<localStorage.length;l++){const m=localStorage.key(l);if(m&&m.startsWith("sb-")&&m.endsWith("-auth-token"))try{const g=localStorage.getItem(m);if(g){const y=JSON.parse(g);if((S=y.user)!=null&&S.id){r=y.user.id;break}}}catch{}}const d=!!await u.getItem("manual_worker_session")?null:r,a={id:o,employeeId:e.employeeId,userId:e.employeeId,teamId:e.teamId||null,companyId:e.companyId||null,recordType:e.recordType,type:e.recordType==="entry"?"IN":"OUT",photoUrl:e.photoUrl||null,location:e.latitude?`${e.latitude},${e.longitude}`:"N/A",latitude:e.latitude??null,longitude:e.longitude??null,recordedAt:e.recordedAt||new Date,createdBy:d,syncedAt:null,localId:o},_=navigator.onLine;if(s.value=[a,...s.value],await i(s.value),_)try{const{data:l,error:m}=await f.from("time_records").insert({user_id:e.employeeId,team_id:e.teamId||null,company_id:e.companyId||null,record_type:e.recordType,photo_url:e.photoUrl||null,latitude:e.latitude??null,longitude:e.longitude??null,recorded_at:(a.recordedAt instanceof Date?a.recordedAt:new Date(a.recordedAt)).toISOString(),created_by:d,synced_at:new Date().toISOString(),local_id:o}).select("*, user:users!time_records_user_id_fkey(name)").single();if(m)throw m;const g={...a,id:l.id,employeeName:(T=l.user)==null?void 0:T.name,syncedAt:new Date(l.synced_at||new Date)};return s.value=s.value.map(y=>y.localId===o?g:y),await i(s.value),{success:!0,data:g}}catch(l){return console.warn("Online sync failed, falling back to offline mode. Error:",l instanceof Error?l.message:"Unknown error"),await u.addToSyncQueue({operation:"insert",table:"time_records",data:{...e,localId:o,recordedAt:(a.recordedAt instanceof Date?a.recordedAt:new Date(a.recordedAt)).toISOString(),createdBy:d}}),w({title:"Salvo offline",description:"Registro salvo no dispositivo. Será sincronizado quando houver conexão.",duration:3e3}),{success:!0,data:a,offline:!0}}else return await u.addToSyncQueue({operation:"insert",table:"time_records",data:{...e,localId:o,recordedAt:(a.recordedAt instanceof Date?a.recordedAt:new Date(a.recordedAt)).toISOString(),createdBy:d}}),w({title:"Modo Offline",description:"Registro salvo localmente.",duration:3e3}),{success:!0,data:a,offline:!0}},O=async(e,o)=>{try{const{error:r}=await f.from("time_records").update({user_id:o.employeeId,team_id:o.teamId,record_type:o.recordType,photo_url:o.photoUrl,recorded_at:(o.recordedAt instanceof Date?o.recordedAt:new Date(o.recordedAt)).toISOString(),latitude:o.latitude,longitude:o.longitude}).eq("id",e);if(r)throw r;const n=s.value.map(c=>c.id===e?{...c,...o}:c);return s.value=n,await i(n),{success:!0}}catch(r){console.warn("Online update failed, falling back to offline mode. Error:",r instanceof Error?r.message:"Unknown error");const n=s.value.map(c=>c.id===e?{...c,...o}:c);return s.value=n,await i(n),await u.addToSyncQueue({operation:"update",table:"time_records",itemId:e,data:o}),w({title:"Atualização offline",description:"As alterações foram salvas localmente e serão sincronizadas em breve."}),{success:!0,offline:!0}}},U=async e=>{try{const{error:o}=await f.from("time_records").delete().eq("id",e);if(o)throw o;const r=s.value.filter(n=>n.id!==e);return s.value=r,await i(r),{success:!0}}catch(o){console.warn("Online delete failed, falling back to offline mode. Error:",o instanceof Error?o.message:"Unknown error");const r=s.value.filter(n=>n.id!==e);return s.value=r,await i(r),await u.addToSyncQueue({operation:"delete",table:"time_records",itemId:e}),w({title:"Exclusão offline",description:"O registro foi removido localmente e será excluído do servidor em breve."}),{success:!0,offline:!0}}},E=async(e,o)=>{try{const r={};o.photoUrl===null&&(r.photo_url=null),o.latitude===null&&(r.latitude=null),o.longitude===null&&(r.longitude=null),o.recordType&&(r.record_type=o.recordType);const{error:n}=await f.from("time_records").update(r).in("id",e);if(n)throw n;const c=s.value.map(d=>e.includes(d.id)?{...d,...o}:d);return s.value=c,await i(c),{success:!0}}catch(r){return console.error("Error in bulk update:",r),{success:!1,error:r.message}}},L=async e=>{try{const{error:o}=await f.from("time_records").delete().in("id",e);if(o)throw o;const r=s.value.filter(n=>!e.includes(n.id));return s.value=r,await i(r),{success:!0}}catch(o){return console.error("Error in bulk delete:",o),{success:!1,error:o.message}}},N=()=>{const e=new Date().toDateString();return s.value.filter(o=>{var r;return((r=v(o.recordedAt))==null?void 0:r.toDateString())===e})};return{records:s.value,isLoading:b,createRecord:D,updateRecord:O,bulkUpdateRecords:E,bulkDeleteRecords:L,deleteRecord:U,getTodayRecords:N,refresh:h}}export{B as u};
