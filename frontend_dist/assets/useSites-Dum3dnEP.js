import{r as p,g as b,u as H,W as y,as as N,E as A,a2 as w}from"./index-D951x4H-.js";function R(l,m){const[D,d]=p.useState([]),[L,_]=p.useState(!1),{toast:f}=b(),{profile:s}=H(),j=p.useRef(!1),S=s==null?void 0:s.id,h=s==null?void 0:s.role,x=s==null?void 0:s.companyId,I=p.useCallback(async(o=!1)=>{if(!((L||j.current)&&!o)){_(!0),j.current=!0;try{if(navigator.onLine){let t=y.from("sites").select("*, project(id, companyId)");const n=N(s)||A(h,s),e=m||(n?void 0:x);l&&(t=t.eq("projectId",l)),e&&(t=t.eq("companyId",e));const{data:a,error:c}=await t.order("name");if(c)throw c;const i=(a||[]).map(r=>{var u,v,g;return{id:r.id,projectId:r.projectId||r.project_id||((u=r.project)==null?void 0:u.id),companyId:r.companyId||((v=r.project)==null?void 0:v.companyId)||((g=r.project)==null?void 0:g.company_id),name:r.name,locationDetails:r.locationDetails||r.location_details,plannedHours:Number(r.plannedHours||r.planned_hours||0),xLat:Number(r.xLat||r.x_lat||0)||null,yLa:Number(r.yLa||r.y_la||0)||null,createdAt:new Date(r.createdAt||r.created_at||Date.now())}});d(i),await w.setItem("sites",i)}else{let n=await w.getItem("sites")||[];l&&(n=n.filter(e=>e.projectId===l)),m&&(n=n.filter(e=>e.companyId===m)),d(n)}}catch(t){console.error("Error loading sites:",t)}finally{_(!1)}}},[l,m,S,h,x]);return p.useEffect(()=>{I()},[I]),{sites:D,isLoading:L,createSite:async o=>{var t,n;try{const{data:e,error:a}=await y.from("sites").insert({projectId:o.projectId,name:o.name,locationDetails:o.locationDetails,plannedHours:o.plannedHours||0,xLat:o.xLat||null,yLa:o.yLa||null}).select().single();if(a)throw a;const c={id:e.id,projectId:e.projectId||e.project_id,companyId:o.companyId||((t=e.project)==null?void 0:t.companyId)||((n=e.project)==null?void 0:n.company_id),name:e.name,locationDetails:e.locationDetails||e.location_details,plannedHours:Number(e.plannedHours||e.planned_hours||0),xLat:Number(e.xLat||e.x_lat||0)||null,yLa:Number(e.yLa||e.y_la||0)||null,createdAt:new Date(e.createdAt||e.created_at)};return d(i=>[...i,c]),{success:!0,data:c}}catch(e){return f({title:"Erro ao criar canteiro",description:e.message,variant:"destructive"}),{success:!1,error:e.message}}},updateSite:async(o,t)=>{var n,e;try{const{data:a,error:c}=await y.from("sites").update({projectId:t.projectId,name:t.name,locationDetails:t.locationDetails,plannedHours:t.plannedHours!==void 0?t.plannedHours:void 0,xLat:t.xLat!==void 0?t.xLat:void 0,yLa:t.yLa!==void 0?t.yLa:void 0}).eq("id",o).select("*, projects(company_id)").single();if(c)throw c;const i={id:a.id,projectId:a.projectId||a.project_id,companyId:t.companyId||((n=a.project)==null?void 0:n.companyId)||((e=a.project)==null?void 0:e.company_id),name:a.name,locationDetails:a.locationDetails||a.location_details,plannedHours:Number(a.plannedHours||a.planned_hours||0),xLat:Number(a.xLat||a.x_lat||0)||null,yLa:Number(a.yLa||a.y_la||0)||null,createdAt:new Date(a.createdAt||a.created_at)};return d(r=>r.map(u=>u.id===o?i:u)),{success:!0,data:i}}catch(a){return f({title:"Erro ao atualizar canteiro",description:a.message,variant:"destructive"}),{success:!1,error:a.message}}},deleteSite:async o=>{try{const{error:t}=await y.from("sites").delete().eq("id",o);if(t)throw t;return d(n=>n.filter(e=>e.id!==o)),{success:!0}}catch(t){return f({title:"Erro ao excluir canteiro",description:t.message,variant:"destructive"}),{success:!1,error:t.message}}},refresh:I}}export{R as u};
